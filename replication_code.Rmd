---
title: "Replication: Upzoning and Residential Transaction Price in Nashville"
author: "Code Written by Nicholas Forster-Benson"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
    fig_caption: true
    fig_width: 6
    fig_height: 4
    keep_tex: true
    latex_engine: xelatex
fontsize: 11pt
mainfont: "Times New Roman"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center"
)
library(stargazer)
library(AER)
library(ggplot2)
library(plm)
library(dplyr)
library(tidyverse)
library(qte)
library(fixest)
library(readxl)
library(randomForest)
library(gbm) 
library(MatchIt)
library(plotly)
library(quantreg)
library(mgcv) 
```
# Document Description

 This PDF document is in correspondence with the manuscript "Upzoning and Residential Transaction Price in Nashville" by Nicholas Forster-Benson and Karim Nchare, available at <https://nfb77.github.io/Files/URTPN.pdf>. It compares residential sale prices of upzoned parcels -part of Nashville’s 2010 ‘Downtown Code’ (DTC) upzoning- with various geographic control boundaries as well as synthetic controls created through matching methods. This is achieved using both Difference-in-Differences (DiD), Quantile Difference-in-Dofferences (QDiD). For usage instructions and data sources please see <https://github.com/nfb77/ZoningNashville>.


# Data Visualization and Descriptive Statistics

## Producing Log of Price by Treatment Figures with Geographic Controls

The order of figures is: Yearly trends by 1 Kilometer Control, 3 Kilometer Control, 5 Kilometer Control, 10 Kilometer Control. The final figure uses monthly averages from the 3 Kilometer Control vs treated in the pre-treatment period.

```{r}

# 1 Kilometer Control

DID1k <- read.csv("data/1km_Boundary.csv")
DID1k <- DID1k[,1:25]
DID1k <- DID1k[DID1k$SalePrice < 2500000 & DID1k$SalePrice >= 1, ]
DID1k$FinishArea[DID1k$FinishArea == 0] <- 449
DID1k$LnSalePrice <- log(DID1k$SalePrice + 1)
DID1k$PricePerSqrft <- (DID1k$SalePrice/(DID1k$FinishArea))
DID1k$LnPricePerSqrft <- log(DID1k$SalePrice/(DID1k$FinishArea))
DID1k <- DID1k[!is.na(DID1k$CoreBin) & !is.na(DID1k$Age) & !is.na(DID1k$FinishArea) & !is.na(DID1k$LnSalePrice) &  !is.na(DID1k$SalePrice),]

DID1k_avg <- DID1k %>%
  group_by(Year, CoreBin) %>%
  summarize(mean_LnSalePrice = mean(LnSalePrice, na.rm = TRUE))

# Plot the summarized data
DID1k_avg %>%
 ggplot(aes(x = Year, y = mean_LnSalePrice, group = CoreBin, color = as.factor(CoreBin))) +
  geom_line(linewidth = 1) +
  scale_y_continuous(limits = c(10, 15)) +
  scale_x_discrete("Year",labels=c("2000","", "", "", "" ,"2005", "", "" ,"", "", "2010", "" ,"", "" ,"" ,"2015" ,"" ,"" ,"", "", "2020", "", "", "")) +  # Display every 5th year
  labs(y = "Log of Average Sale Price", x = "Year",color = "Treatment") +
  geom_vline(xintercept = "2010", linetype = "dashed", color = "black", linewidth = 1) + 
  scale_color_discrete(labels = c("Control", "Treatment")) + 
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))


#Now we repeat with 3K
DID3k <- read.csv("data/3km_Boundary.csv")
DID3k$SaleMonth <- (((DID3k$SaleYear-2000)*12)+DID3k$MonthByYear)
DID3k$SaleMonthP <- (((DID3k$SaleYear-2000)*12)+DID3k$MonthByYear-128)
DID3k <- DID3k[DID3k$SalePrice < 2500000 & DID3k$SalePrice >= 1, ]
DID3k$FinishArea[DID3k$FinishArea == 0] <- 449
DID3k$LnSalePrice <- log(DID3k$SalePrice + 1)
DID3k$PricePerSqrft <- (DID3k$SalePrice/(DID3k$FinishArea))
DID3k$LnPricePerSqrft <- log(DID3k$SalePrice/(DID3k$FinishArea))
DID3k <- DID3k[!is.na(DID3k$CoreBin) & !is.na(DID3k$Age) & !is.na(DID3k$FinishArea) & !is.na(DID3k$LnSalePrice) &  !is.na(DID3k$SalePrice),]

DID3k_avg <- DID3k %>%
  group_by(Year, CoreBin) %>%
  summarize(mean_LnSalePrice = mean(LnSalePrice, na.rm = TRUE))

# Plot the summarized data
DID3k_avg %>%
 ggplot(aes(x = Year, y = mean_LnSalePrice, group = CoreBin, color = as.factor(CoreBin))) +
  geom_line(linewidth = 1) +
  scale_y_continuous(limits = c(10, 15)) +
  scale_x_discrete("Year",labels=c("2000","", "", "", "" ,"2005", "", "" ,"", "", "2010", "" ,"", "" ,"" ,"2015" ,"" ,"" ,"", "", "2020", "", "", "")) +  # Display every 5th year
  labs(y = "Log of Average Sale Price", x = "Year",color = "Treatment") +
  geom_vline(xintercept = "2010", linetype = "dashed", color = "black", linewidth = 1) + 
  scale_color_discrete(labels = c("Control", "Treatment")) +  
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))



#Now we repeat with 5K
DID5k <- read.csv("data/5km_Boundary.csv")
DID5k <- DID5k[,1:25]
DID5k <- DID5k[DID5k$SalePrice < 2500000 & DID5k$SalePrice >= 1, ]
DID5k$FinishArea[DID5k$FinishArea == 0] <- 449
DID5k$LnSalePrice <- log(DID5k$SalePrice + 1)
DID5k$PricePerSqrft <- (DID5k$SalePrice/(DID5k$FinishArea))
DID5k$LnPricePerSqrft <- log(DID5k$SalePrice/(DID5k$FinishArea))
DID5k <- DID5k[!is.na(DID5k$CoreBin) & !is.na(DID5k$Age) & !is.na(DID5k$FinishArea) & !is.na(DID5k$LnSalePrice) &  !is.na(DID5k$SalePrice),]


DID5k_avg <- DID5k %>%
  group_by(Year, CoreBin) %>%
  summarize(mean_LnSalePrice = mean(LnSalePrice, na.rm = TRUE))

# Plot the summarized data
DID5k_avg %>%
 ggplot(aes(x = Year, y = mean_LnSalePrice, group = CoreBin, color = as.factor(CoreBin))) +
  geom_line(linewidth = 1) +
  scale_y_continuous(limits = c(10, 15)) +
  scale_x_discrete("Year",labels=c("2000","", "", "", "" ,"2005", "", "" ,"", "", "2010", "" ,"", "" ,"" ,"2015" ,"" ,"" ,"", "", "2020", "", "", "")) +  # Display every 5th year
  labs(y = "Log of Average Sale Price", x = "Year",color = "Treatment") +
  geom_vline(xintercept = "2010", linetype = "dashed", color = "black", linewidth = 1) + 
  scale_color_discrete(labels = c("Control", "Treatment")) +  
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))


#Now we repeat with 10K
DID10K <- read.csv("data/10km_Boundary.csv")
DID10K <- DID10K[DID10K$SalePrice < 2500000 & DID10K$SalePrice >= 1, ]
DID10K$FinishArea[DID10K$FinishArea == 0] <- 449
DID10K$LnSalePrice <- log(DID10K$SalePrice + 1)
DID10K$PricePerSqrft <- (DID10K$SalePrice/(DID10K$FinishArea))
DID10K$LnPricePerSqrft <- log(DID10K$SalePrice/(DID10K$FinishArea))
DID10K <- DID10K[!is.na(DID10K$CoreBin) & !is.na(DID10K$Age) & !is.na(DID10K$FinishArea) & !is.na(DID10K$LnSalePrice) &  !is.na(DID10K$SalePrice),]  


# Plot the summarized data with custom legend
DID10k_avg <- DID10K %>%
  group_by(Year, CoreBin) %>%
  summarize(mean_LnSalePrice = mean(LnSalePrice, na.rm = TRUE))

# Plot the summarized data
DID10k_avg %>%
 ggplot(aes(x = Year, y = mean_LnSalePrice, group = CoreBin, color = as.factor(CoreBin))) +
  geom_line(linewidth = 1) +
  scale_y_continuous(limits = c(10, 15)) +
  scale_x_discrete("Year",labels=c("2000","", "", "", "" ,"2005", "", "" ,"", "", "2010", "" ,"", "" ,"" ,"2015" ,"" ,"" ,"", "", "2020", "", "", "")) +  # Display every 5th year
  labs(y = "Log of Average Sale Price", x = "Year",color = "Treatment") +
  geom_vline(xintercept = "2010", linetype = "dashed", color = "black", linewidth = 1) + 
  scale_color_discrete(labels = c("Control", "Treatment")) +  
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))




###########Creating the pre-treatment trends ols fit##################


############# 3km control group vs treatment ##################
DID3k$SaleMonth <- (((DID3k$SaleYear-2000)*12)+DID3k$MonthByYear)
DID3k$SaleMonthP <- (((DID3k$SaleYear-2000)*12)+DID3k$MonthByYear-128)
DID3k$Year <- as.character(as.numeric(DID3k$Year))

DID3k_avg <- DID3k %>%
  group_by(SaleMonthP, CoreBin) %>%
  summarize(mean_LnSalePrice = mean(LnSalePrice, na.rm = TRUE))

DID3k_avg_filtered <- DID3k_avg %>%
  filter(SaleMonthP >= -120 & SaleMonthP <= 0)


DID3k_avg_filtered %>%
  ggplot(aes(x = SaleMonthP, y = mean_LnSalePrice, group = CoreBin, color = as.factor(CoreBin))) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +  # Add linear fit lines without confidence interval shading
  scale_y_continuous(limits = c(10, 15)) +
  labs(y = "Monthly Average Logged Sale Price", x = "Months Prior to Re-Zoning", color = "Treatment") +
  scale_color_discrete(labels = c("Control", "Treatment")) +  # Optional: set labels for legend categories
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
  )


```

## Producing Log of Price by Treatment Figures With Matching Controls

The order of figures is: Propensity Score Matching (PSM) Control, Generalized Boosted Matching (GBM) Control, Random Forest Matching (RFM) Control. The final figure uses monthly averages fromPropensity Score Matching Control vs treated in the pre-treatment period.

```{r}
########### Producing Log of Price by  Treatment figures with Matching controls  #################


DTC_DID_Full <- read.csv("data/Full_Control.csv")
DTC_DID_Full <- DTC_DID_Full[DTC_DID_Full$SalePrice < 2500000 & DTC_DID_Full$SalePrice >= 1, ]
# Filter rows where specified columns are not NA
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & 
                             !is.na(DTC_DID_Full$Age) & 
                             !is.na(DTC_DID_Full$PrcntWhite) & 
                             !is.na(DTC_DID_Full$BAorHigher) & 
                             !is.na(DTC_DID_Full$BuildPreTrt), ]
DTC_DID_Full$FinishArea[DTC_DID_Full$FinishArea == 0] <- 449
DTC_DID_Full$LnSalePrice <- log(DTC_DID_Full$SalePrice + 1)
DTC_DID_Full$PricePerSqrft <- (DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full$LnPricePerSqrft <- log(DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & !is.na(DTC_DID_Full$Age) & !is.na(DTC_DID_Full$FinishArea) & !is.na(DTC_DID_Full$LnSalePrice) &  !is.na(DTC_DID_Full$SalePrice),]
DTC_DID_Full$BAorHigher <- as.numeric(as.character(DTC_DID_Full$BAorHigher))

DTC_DIDT1 <-  subset(DTC_DID_Full, TimeBin == 1)
DTC_DIDT0 <-  subset(DTC_DID_Full, TimeBin == 0)

ps<- glm(CoreBin ~  SalePrice+ Age+ FinishArea+ PrcntWhite+ BAorHigher + BuildPreTrt, data=DTC_DID_Full, family =binomial())

DTC_DID_Full$psvalue <- predict(ps, type = "response")

gps<- gbm(CoreBin ~  SalePrice+ Age+ FinishArea+ PrcntWhite+ BAorHigher+ BuildPreTrt, distribution="bernoulli", data=DTC_DID_Full, n.trees=100, interaction.depth=4, train.fraction= 0.8, shrinkage=0.0005) 

DTC_DID_Full$gpsvalue <-  predict(gps, type = "response")

DTC_DID_Full$CoreBin <- as.factor(DTC_DID_Full$CoreBin)

# Fit a random forest model for propensity score estimation
rf_model <- randomForest(CoreBin ~ SalePrice+ Age + FinishArea + PrcntWhite + BAorHigher + BuildPreTrt, 
                         data = DTC_DID_Full, 
                         ntree = 500,        # Number of trees
                         mtry = 3,           # Number of variables randomly sampled at each split
                         nodesize = 5)       # Minimum size of terminal nodes

# Predict propensity scores for the new dataset
DTC_DID_Full$rf_psvalue <- predict(rf_model, type = "prob")[,2]  # type = "prob" gives class probabilities

#data for rejoining the treatment and control after matching the control
DTC_DID_Full_Treat <- subset(DTC_DID_Full, CoreBin == 1)
DTC_DID_Full_Control <- subset(DTC_DID_Full, CoreBin == 0)


psvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$psvalue), ][1:10000, ]
psvalue_top <- rbind(psvalue_top, DTC_DID_Full_Treat)

gpsvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$gpsvalue), ][1:12500, ]
gpsvalue_top<- rbind(gpsvalue_top, DTC_DID_Full_Treat)


rf_psvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$rf_psvalue), ][1:17000, ]
rf_psvalue_top <- rbind(rf_psvalue_top, DTC_DID_Full_Treat)



############# Propensity Score Matching ##################

psvalue_top$Year <- as.character(as.numeric(psvalue_top$Year))

psvalue_top_avg <- psvalue_top %>%
  group_by(Year, CoreBin) %>%
  summarize(mean_LnSalePrice = mean(LnSalePrice, na.rm = TRUE))

# Plot the summarized data
psvalue_top_avg %>%
 ggplot(aes(x = Year, y = mean_LnSalePrice, group = CoreBin, color = as.factor(CoreBin))) +
  geom_line(linewidth = 1) +
  scale_y_continuous(limits = c(10, 15)) +
  scale_x_discrete("Year",labels=c("2000","", "", "", "" ,"2005", "", "" ,"", "", "2010", "" ,"", "" ,"" ,"2015" ,"" ,"" ,"", "", "2020", "", "", "")) +  # Display every 5th year
  labs(y = "Log of Average Sale Price", x = "Year",color = "Treatment") +
  geom_vline(xintercept = "2010", linetype = "dashed", color = "black", linewidth = 1) + 
  scale_color_discrete(labels = c("Control", "Treatment")) +  
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))




############## Generalized Boosted Matching ##################
# Plot the summarized data with custom legend
gpsvalue_top$Year <- as.character(as.numeric(gpsvalue_top$Year))

gpsvalue_top_avg <- gpsvalue_top %>%
  group_by(Year, CoreBin) %>%
  summarize(mean_LnSalePrice = mean(LnSalePrice, na.rm = TRUE))

# Plot the summarized data
gpsvalue_top_avg %>%
 ggplot(aes(x = Year, y = mean_LnSalePrice, group = CoreBin, color = as.factor(CoreBin))) +
  geom_line(linewidth = 1) +
  scale_y_continuous(limits = c(10, 15)) +
  scale_x_discrete("Year",labels=c("2000","", "", "", "" ,"2005", "", "" ,"", "", "2010", "" ,"", "" ,"" ,"2015" ,"" ,"" ,"", "", "2020", "", "", "")) +  # Display every 5th year
  labs(y = "Log of Average Sale Price", x = "Year",color = "Treatment") +
  geom_vline(xintercept = "2010", linetype = "dashed", color = "black", linewidth = 1) + 
  scale_color_discrete(labels = c("Control", "Treatment")) +  
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))


############## Random Forest Matching##################
rf_psvalue_top$Year <- as.character(as.numeric(rf_psvalue_top$Year))

rf_psvalue_top_avg <- rf_psvalue_top %>%
  group_by(Year, CoreBin) %>%
  summarize(mean_LnSalePrice = mean(LnSalePrice, na.rm = TRUE))

# Plot the summarized data
rf_psvalue_top_avg %>%
 ggplot(aes(x = Year, y = mean_LnSalePrice, group = CoreBin, color = as.factor(CoreBin))) +
  geom_line(linewidth = 1) +
  scale_y_continuous(limits = c(10, 15)) +
  scale_x_discrete("Year",labels=c("2000","", "", "", "" ,"2005", "", "" ,"", "", "2010", "" ,"", "" ,"" ,"2015" ,"" ,"" ,"", "", "2020", "", "", "")) +  # Display every 5th year
  labs(y = "Log of Average Sale Price", x = "Year",color = "Treatment") +
  geom_vline(xintercept = "2010", linetype = "dashed", color = "black", linewidth = 1) + 
  scale_color_discrete(labels = c("Control", "Treatment")) +  
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))



###########Creating the pre-treatment trends ols fit##################
############# Propensity Score Matching ##################
psvalue_top$SaleMonth <- (((psvalue_top$SaleYear-2000)*12)+psvalue_top$MonthByYear)
psvalue_top$SaleMonthP <- (((psvalue_top$SaleYear-2000)*12)+psvalue_top$MonthByYear-128)
psvalue_top$Year <- as.character(as.numeric(psvalue_top$Year))

psvalue_top_avg <- psvalue_top %>%
  group_by(SaleMonthP, CoreBin) %>%
  summarize(mean_LnSalePrice = mean(LnSalePrice, na.rm = TRUE))

psvalue_top_avg_filtered <- psvalue_top_avg %>%
  filter(SaleMonthP >= -120 & SaleMonthP <= 0)


psvalue_top_avg_filtered %>%
  ggplot(aes(x = SaleMonthP, y = mean_LnSalePrice, group = CoreBin, color = as.factor(CoreBin))) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +  # Add linear fit lines without confidence interval shading
  scale_y_continuous(limits = c(10, 15)) +
  labs(y = "Monthly Average Logged Sale Price", x = "Months Prior to Re-Zoning", color = "Treatment") +
  scale_color_discrete(labels = c("Control", "Treatment")) +  # Optional: set labels for legend categories
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
  )


```

## Pre-treatment Placebo with Matched Controls (PSM) and Geographic Controls (3km)

```{r}

#############Pre-treatment placebo with matched controls (PSM) ############

DTC_DID_Full <- read.csv("data/Full_Control.csv")
DTC_DID_Full <- DTC_DID_Full[DTC_DID_Full$SalePrice < 2500000 & DTC_DID_Full$SalePrice >= 1, ]
# Filter rows where specified columns are not NA
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & 
                             !is.na(DTC_DID_Full$Age) & 
                             !is.na(DTC_DID_Full$PrcntWhite) & 
                             !is.na(DTC_DID_Full$BAorHigher) & 
                             !is.na(DTC_DID_Full$BuildPreTrt), ]
DTC_DID_Full$FinishArea[DTC_DID_Full$FinishArea == 0] <- 449
DTC_DID_Full$LnSalePrice <- log(DTC_DID_Full$SalePrice + 1)
DTC_DID_Full$PricePerSqrft <- (DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full$LnPricePerSqrft <- log(DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & !is.na(DTC_DID_Full$Age) & !is.na(DTC_DID_Full$FinishArea) & !is.na(DTC_DID_Full$LnSalePrice) &  !is.na(DTC_DID_Full$SalePrice),]
DTC_DID_Full$BAorHigher <- as.numeric(as.character(DTC_DID_Full$BAorHigher))

DTC_DIDT1 <-  subset(DTC_DID_Full, TimeBin == 1)
DTC_DIDT0 <-  subset(DTC_DID_Full, TimeBin == 0)



ps<- glm(CoreBin ~  SalePrice+ Age+ FinishArea+ PrcntWhite+ BAorHigher + BuildPreTrt, data=DTC_DID_Full, family =binomial())
summary(ps)

DTC_DID_Full$psvalue <- predict(ps, type = "response")

DTC_DID_Full_Treat <-subset(DTC_DID_Full, CoreBin == 1)
DTC_DID_Full_Control <-subset(DTC_DID_Full, CoreBin == 0)


psvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$psvalue), ][1:10000, ]
psvalue_top <- rbind(psvalue_top, DTC_DID_Full_Treat)
m.out1 <- matchit(CoreBin ~  Age+ FinishArea+ PrcntWhite+ BAorHigher + BuildPreTrt, data = psvalue_top,
                 method = NULL, distance = "glm")
# Checking balance after to matching
summary(m.out1)

psvalue_top$TimeBin3 <- ifelse(psvalue_top$Year >= 2003, 1, 0)
psvalue_top$TimeBin4 <- ifelse(psvalue_top$Year >= 2004, 1, 0)
psvalue_top$TimeBin5 <- ifelse(psvalue_top$Year >= 2005, 1, 0)
psvalue_top$TimeBin6 <- ifelse(psvalue_top$Year >= 2006, 1, 0)
psvalue_top$TimeBin7 <- ifelse(psvalue_top$Year >= 2007, 1, 0)
psvalue_top$TimeBin8 <- ifelse(psvalue_top$Year >= 2008, 1, 0)
psvalue_top$TimeBin9 <- ifelse(psvalue_top$Year >= 2009, 1, 0)
psvalue_top$TimeBin10 <- ifelse(psvalue_top$Year >= 2010, 1, 0)
psvalue_top$TimeBin11 <- ifelse(psvalue_top$Year >= 2011, 1, 0)
psvalue_top$TimeBin12 <- ifelse(psvalue_top$Year >= 2012, 1, 0)
psvalue_top$TimeBin13 <- ifelse(psvalue_top$Year >= 2013, 1, 0)
psvalue_top$TimeBin14 <- ifelse(psvalue_top$Year >= 2014, 1, 0)
psvalue_top$TimeBin15 <- ifelse(psvalue_top$Year >= 2015, 1, 0)




DIDmodel3.3 <- lm(LnSalePrice ~ CoreBin*TimeBin3 + Age + factor(Tract) + factor(Year), data = psvalue_top)

DIDmodel3.4 <- lm(LnSalePrice ~ CoreBin*TimeBin4  + Age + factor(Tract) + factor(Year), data = psvalue_top)

DIDmodel3.5 <- lm(LnSalePrice ~ CoreBin*TimeBin5  + Age + factor(Tract) + factor(Year), data = psvalue_top)

DIDmodel3.6 <- lm(LnSalePrice ~ CoreBin*TimeBin6  + Age + factor(Tract) + factor(Year), data = psvalue_top)

DIDmodel3.7 <- lm(LnSalePrice ~ CoreBin*TimeBin7  + Age + factor(Tract) + factor(Year), data = psvalue_top)

DIDmodel3.8 <- lm(LnSalePrice ~ CoreBin*TimeBin8  + Age + factor(Tract) + factor(Year), data = psvalue_top)

DIDmodel3.9 <- lm(LnSalePrice ~ CoreBin*TimeBin9  + Age + factor(Tract) + factor(Year), data = psvalue_top)

DIDmodel3.10 <- lm(LnSalePrice ~ CoreBin*TimeBin10  + Age + factor(Tract) + factor(Year), data = psvalue_top)

DIDmodel3.11 <- lm(LnSalePrice ~ CoreBin*TimeBin11  + Age + factor(Tract) + factor(Year), data = psvalue_top)

DIDmodel3.12 <- lm(LnSalePrice ~ CoreBin*TimeBin12  + Age + factor(Tract) + factor(Year), data = psvalue_top)

DIDmodel3.13 <- lm(LnSalePrice ~ CoreBin*TimeBin13  + Age + factor(Tract) + factor(Year), data = psvalue_top)

DIDmodel3.14 <- lm(LnSalePrice ~ CoreBin*TimeBin14  + Age + factor(Tract) + factor(Year), data = psvalue_top)

DIDmodel3.15 <- lm(LnSalePrice ~ CoreBin*TimeBin15  + Age + factor(Tract) + factor(Year), data = psvalue_top)

model1Frame <- data.frame(Variable = 'T=03',
                          Coefficient = summary(DIDmodel3.3)$coef[,1],
                          SE = summary(DIDmodel3.3)$coef[,2],
                          modelName = "All_PRTColonies")

model2Frame <- data.frame(Variable = 'T=04',
                          Coefficient = summary(DIDmodel3.4)$coef[,1],
                          SE = summary(DIDmodel3.4)$coef[,2],
                          modelName = "PSSAC")

model3Frame <- data.frame(Variable = 'T=05',
                          Coefficient = summary(DIDmodel3.5)$coef[,1],
                          SE = summary(DIDmodel3.5)$coef[,2],
                          modelName = "nonSSA_colonies")

model4Frame <- data.frame(Variable = 'T=06',
                          Coefficient = summary(DIDmodel3.6)$coef[,1],
                          SE = summary(DIDmodel3.6)$coef[,2],
                          modelName = "PRTFrmTer")

model5Frame <- data.frame(Variable = 'T=07',
                          Coefficient = summary(DIDmodel3.7)$coef[,1],
                          SE = summary(DIDmodel3.7)$coef[,2],
                          modelName = "AmericasPRTFrmTer")

model6Frame <- data.frame(Variable = 'T=08',
                          Coefficient = summary(DIDmodel3.8)$coef[,1],
                          SE = summary(DIDmodel3.8)$coef[,2],
                          modelName = "AfricaPRTFrmTer")

model7Frame <- data.frame(Variable = 'T=09',
                          Coefficient = summary(DIDmodel3.9)$coef[,1],
                          SE = summary(DIDmodel3.9)$coef[,2],
                          modelName = "AsiaPRTFrmTer")

model8Frame <- data.frame(Variable = 'T=10',
                          Coefficient = summary(DIDmodel3.10)$coef[,1],
                          SE = summary(DIDmodel3.10)$coef[,2],
                          modelName = "HighPRTFrmTer")

model9Frame <- data.frame(Variable = 'T=11',
                          Coefficient = summary(DIDmodel3.11)$coef[,1],
                          SE = summary(DIDmodel3.11)$coef[,2],
                          modelName = "MidPRTFrmTer")

model10Frame <- data.frame(Variable = 'T=12',
                           Coefficient = summary(DIDmodel3.12)$coef[,1],
                           SE = summary(DIDmodel3.12)$coef[,2],
                           modelName = "LowPRTFrmTer")

model11Frame <- data.frame(Variable = 'T=13',
                           Coefficient = summary(DIDmodel3.13)$coef[,1],
                           SE = summary(DIDmodel3.13)$coef[,2],
                           modelName = "LowPRTFrmTer")
model12Frame <- data.frame(Variable = 'T=14',
                           Coefficient = summary(DIDmodel3.14)$coef[,1],
                           SE = summary(DIDmodel3.14)$coef[,2],
                           modelName = "LowPRTFrmTer")
model13Frame <- data.frame(Variable = 'T=15',
                           Coefficient = summary(DIDmodel3.15)$coef[,1],
                           SE = summary(DIDmodel3.15)$coef[,2],
                           modelName = "LowPRTFrmTer")

model1Frame <- model1Frame[2,]
model2Frame <- model2Frame[2,]
model3Frame <- model3Frame[2,]
model4Frame <- model4Frame[2,]
model5Frame <- model5Frame[2,]
model6Frame <- model6Frame[2,]
model7Frame <- model7Frame[2,]
model8Frame <- model8Frame[2,]
model9Frame <- model9Frame[2,]
model10Frame <- model10Frame[2,]
model11Frame <- model11Frame[2,]
model12Frame <- model12Frame[2,]
model13Frame <- model13Frame[2,]

# Combining all data frames into one
allModelFrame <- bind_rows(model1Frame, model2Frame, model3Frame, model4Frame, model5Frame,
                           model6Frame, model7Frame )
# Specify the width of your confidence intervals
interval1 <- -qnorm((1-0.95)/2)  # 95% multiplier
interval2 <- -qnorm((1-0.99)/2)  # 99% multiplier

# Plot
zp1 <- ggplot(allModelFrame)
zp1 <- zp1 + geom_hline(yintercept = 0, colour = gray(1/2), lty = 2)
zp1 <- zp1 + geom_linerange(aes(x = Variable, ymin = Coefficient - SE*interval1,
                                ymax = Coefficient + SE*interval1),
                            lwd = 1, position = position_dodge(width = 1/2))
zp1 <- zp1 + geom_pointrange(aes(x = Variable, y = Coefficient, ymin = Coefficient - SE*interval2,
                                 ymax = Coefficient + SE*interval2),
                             lwd = 1/2, position = position_dodge(width = 1/2),
                             shape = 21, fill = "WHITE")
zp1 <- zp1 + theme_minimal()
zp1 <- zp1 + xlab("Pre-Treatment Placebo Time (2003-2009)")
zp1 <- zp1 + ylab("Treatment Effect, Ln Sale Price")
zp1 <- zp1 + ggtitle("") +
            theme(plot.title = element_text(hjust = 0.5))
zp1 <- zp1 + scale_y_continuous(expand = c(0, 0))
zp1 <- zp1 + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"))

zp1




#############Pre-treatment placebo with 3km control ############
DID3k <- read.csv("data/3km_Boundary.csv")
DID3k <- DID3k[DID3k$SalePrice < 2500000 & DID3k$SalePrice >= 1, ]
DID3k$FinishArea[DID3k$FinishArea == 0] <- 449
DID3k$LnSalePrice <- log(DID3k$SalePrice + 1)
DID3k$PricePerSqrft <- (DID3k$SalePrice/(DID3k$FinishArea))
DID3k$LnPricePerSqrft <- log(DID3k$SalePrice/(DID3k$FinishArea))
DID3k <- DID3k[!is.na(DID3k$CoreBin) & !is.na(DID3k$Age) & !is.na(DID3k$FinishArea) & !is.na(DID3k$LnSalePrice) &  !is.na(DID3k$SalePrice),]




DID3k$TimeBin3 <- ifelse(DID3k$Year >= 2003, 1, 0)
DID3k$TimeBin4 <- ifelse(DID3k$Year >= 2004, 1, 0)
DID3k$TimeBin5 <- ifelse(DID3k$Year >= 2005, 1, 0)
DID3k$TimeBin6 <- ifelse(DID3k$Year >= 2006, 1, 0)
DID3k$TimeBin7 <- ifelse(DID3k$Year >= 2007, 1, 0)
DID3k$TimeBin8 <- ifelse(DID3k$Year >= 2008, 1, 0)
DID3k$TimeBin9 <- ifelse(DID3k$Year >= 2009, 1, 0)
DID3k$TimeBin10 <- ifelse(DID3k$Year >= 2010, 1, 0)
DID3k$TimeBin11 <- ifelse(DID3k$Year >= 2011, 1, 0)
DID3k$TimeBin12 <- ifelse(DID3k$Year >= 2012, 1, 0)
DID3k$TimeBin13 <- ifelse(DID3k$Year >= 2013, 1, 0)
DID3k$TimeBin14 <- ifelse(DID3k$Year >= 2014, 1, 0)
DID3k$TimeBin15 <- ifelse(DID3k$Year >= 2015, 1, 0)




DIDmodel3.3 <- lm(LnSalePrice ~ CoreBin*TimeBin3 + Age + factor(Tract) + factor(Year), data = DID3k)

DIDmodel3.4 <- lm(LnSalePrice ~ CoreBin*TimeBin4  + Age + factor(Tract) + factor(Year), data = DID3k)

DIDmodel3.5 <- lm(LnSalePrice ~ CoreBin*TimeBin5  + Age + factor(Tract) + factor(Year), data = DID3k)

DIDmodel3.6 <- lm(LnSalePrice ~ CoreBin*TimeBin6  + Age + factor(Tract) + factor(Year), data = DID3k)

DIDmodel3.7 <- lm(LnSalePrice ~ CoreBin*TimeBin7  + Age + factor(Tract) + factor(Year), data = DID3k)

DIDmodel3.8 <- lm(LnSalePrice ~ CoreBin*TimeBin8  + Age + factor(Tract) + factor(Year), data = DID3k)

DIDmodel3.9 <- lm(LnSalePrice ~ CoreBin*TimeBin9  + Age + factor(Tract) + factor(Year), data = DID3k)

DIDmodel3.10 <- lm(LnSalePrice ~ CoreBin*TimeBin10  + Age + factor(Tract) + factor(Year), data = DID3k)

DIDmodel3.11 <- lm(LnSalePrice ~ CoreBin*TimeBin11  + Age + factor(Tract) + factor(Year), data = DID3k)

DIDmodel3.12 <- lm(LnSalePrice ~ CoreBin*TimeBin12  + Age + factor(Tract) + factor(Year), data = DID3k)

DIDmodel3.13 <- lm(LnSalePrice ~ CoreBin*TimeBin13  + Age + factor(Tract) + factor(Year), data = DID3k)

DIDmodel3.14 <- lm(LnSalePrice ~ CoreBin*TimeBin14  + Age + factor(Tract) + factor(Year), data = DID3k)

DIDmodel3.15 <- lm(LnSalePrice ~ CoreBin*TimeBin15  + Age + factor(Tract) + factor(Year), data = DID3k)

model1Frame <- data.frame(Variable = 'T=03',
                          Coefficient = summary(DIDmodel3.3)$coef[,1],
                          SE = summary(DIDmodel3.3)$coef[,2],
                          modelName = "All_PRTColonies")

model2Frame <- data.frame(Variable = 'T=04',
                          Coefficient = summary(DIDmodel3.4)$coef[,1],
                          SE = summary(DIDmodel3.4)$coef[,2],
                          modelName = "PSSAC")

model3Frame <- data.frame(Variable = 'T=05',
                          Coefficient = summary(DIDmodel3.5)$coef[,1],
                          SE = summary(DIDmodel3.5)$coef[,2],
                          modelName = "nonSSA_colonies")

model4Frame <- data.frame(Variable = 'T=06',
                          Coefficient = summary(DIDmodel3.6)$coef[,1],
                          SE = summary(DIDmodel3.6)$coef[,2],
                          modelName = "PRTFrmTer")

model5Frame <- data.frame(Variable = 'T=07',
                          Coefficient = summary(DIDmodel3.7)$coef[,1],
                          SE = summary(DIDmodel3.7)$coef[,2],
                          modelName = "AmericasPRTFrmTer")

model6Frame <- data.frame(Variable = 'T=08',
                          Coefficient = summary(DIDmodel3.8)$coef[,1],
                          SE = summary(DIDmodel3.8)$coef[,2],
                          modelName = "AfricaPRTFrmTer")

model7Frame <- data.frame(Variable = 'T=09',
                          Coefficient = summary(DIDmodel3.9)$coef[,1],
                          SE = summary(DIDmodel3.9)$coef[,2],
                          modelName = "AsiaPRTFrmTer")

model8Frame <- data.frame(Variable = 'T=10',
                          Coefficient = summary(DIDmodel3.10)$coef[,1],
                          SE = summary(DIDmodel3.10)$coef[,2],
                          modelName = "HighPRTFrmTer")

model9Frame <- data.frame(Variable = 'T=11',
                          Coefficient = summary(DIDmodel3.11)$coef[,1],
                          SE = summary(DIDmodel3.11)$coef[,2],
                          modelName = "MidPRTFrmTer")

model10Frame <- data.frame(Variable = 'T=12',
                           Coefficient = summary(DIDmodel3.12)$coef[,1],
                           SE = summary(DIDmodel3.12)$coef[,2],
                           modelName = "LowPRTFrmTer")

model11Frame <- data.frame(Variable = 'T=13',
                           Coefficient = summary(DIDmodel3.13)$coef[,1],
                           SE = summary(DIDmodel3.13)$coef[,2],
                           modelName = "LowPRTFrmTer")
model12Frame <- data.frame(Variable = 'T=14',
                           Coefficient = summary(DIDmodel3.14)$coef[,1],
                           SE = summary(DIDmodel3.14)$coef[,2],
                           modelName = "LowPRTFrmTer")
model13Frame <- data.frame(Variable = 'T=15',
                           Coefficient = summary(DIDmodel3.15)$coef[,1],
                           SE = summary(DIDmodel3.15)$coef[,2],
                           modelName = "LowPRTFrmTer")

model1Frame <- model1Frame[2,]
model2Frame <- model2Frame[2,]
model3Frame <- model3Frame[2,]
model4Frame <- model4Frame[2,]
model5Frame <- model5Frame[2,]
model6Frame <- model6Frame[2,]
model7Frame <- model7Frame[2,]
model8Frame <- model8Frame[2,]
model9Frame <- model9Frame[2,]
model10Frame <- model10Frame[2,]
model11Frame <- model11Frame[2,]
model12Frame <- model12Frame[2,]
model13Frame <- model13Frame[2,]

# Combining all data frames into one
allModelFrame <- bind_rows(model1Frame, model2Frame, model3Frame, model4Frame, model5Frame,
                           model6Frame, model7Frame )
# Specify the width of your confidence intervals
interval1 <- -qnorm((1-0.95)/2)  # 95% multiplier
interval2 <- -qnorm((1-0.99)/2)  # 99% multiplier

# Plot
zp2 <- ggplot(allModelFrame)
zp2 <- zp2 + geom_hline(yintercept = 0, colour = gray(1/2), lty = 2)
zp2 <- zp2 + geom_linerange(aes(x = Variable, ymin = Coefficient - SE*interval1,
                                ymax = Coefficient + SE*interval1),
                            lwd = 1, position = position_dodge(width = 1/2))
zp2 <- zp2 + geom_pointrange(aes(x = Variable, y = Coefficient, ymin = Coefficient - SE*interval2,
                                 ymax = Coefficient + SE*interval2),
                             lwd = 1/2, position = position_dodge(width = 1/2),
                             shape = 21, fill = "WHITE")
zp2 <- zp2 + theme_minimal()
zp2 <- zp2 + xlab("Pre-Treatment Placebo Time (2003-2009)")
zp2 <- zp2 + ylab("Treatment Effect, Ln Sale Price")
zp2 <- zp2 + ggtitle("") +
            theme(plot.title = element_text(hjust = 0.5))
zp2 <- zp2 + scale_y_continuous(expand = c(0, 0))
zp2 <- zp2 + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"))

zp2
```

## Descriptive Statistics

```{r results = "asis"}

##########Additional Descriptive statistics ##########


DTC_DID_Full <- read.csv("data/Full_Control.csv")
DTC_DID_Full <- DTC_DID_Full[,1:23]
DTC_DID_Full <- DTC_DID_Full[DTC_DID_Full$SalePrice < 2500000 & DTC_DID_Full$SalePrice >= 1, ]
DTC_DID_Full$FinishArea[DTC_DID_Full$FinishArea == 0] <- 449
DTC_DID_Full$LnSalePrice <- log(DTC_DID_Full$SalePrice + 1)
DTC_DID_Full$PricePerSqrft <- (DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full$LnPricePerSqrft <- (DTC_DID_Full$LnSalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & !is.na(DTC_DID_Full$Age) & !is.na(DTC_DID_Full$FinishArea) & !is.na(DTC_DID_Full$LnSalePrice) &  !is.na(DTC_DID_Full$SalePrice),]


DTC_DIDT1 <-  subset(DTC_DID_Full, TimeBin == 1)
DTC_DIDT0 <-  subset(DTC_DID_Full, TimeBin == 0)

DTC_DIDT0_C1 <-  subset(DTC_DIDT0, CoreBin == 1)
DTC_DIDT0_C0 <-  subset(DTC_DIDT0, CoreBin == 0)

DTC_DIDT1_C1 <-  subset(DTC_DIDT1, CoreBin == 1)
DTC_DIDT1_C0 <-  subset(DTC_DIDT1, CoreBin == 0)

#stargazer(DTC_DID_Full[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], 
#          type = "text", 
#          title = "Summary Statistics", 
 #         summary.stat = c("n", "mean", "sd", "min", "p25", "p75", "max"))
df <- DTC_DID_Full

summary_data_Full <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(summary_data_Full, type = "text", summary = FALSE, title = "Summary Statistics All of Davidson County 2000-2023")

df <- DTC_DIDT0_C1
sum_Treat_DTC_DIDT0_C1 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)
#stargazer(sum_Treat_DTC_DIDT0_C1, type = "text", summary = FALSE, title = "Treatment Before")

df <- DTC_DIDT1_C1

sum_Treat_DTC_DIDT1_C1 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_Treat_DTC_DIDT1_C1, type = "text", summary = FALSE, title = "Treatment After")



df <- DTC_DIDT0_C0

sum_Full_DTC_DIDT0_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_Full_DTC_DIDT0_C0, type = "text", summary = FALSE, title = "Control Before")

df <- DTC_DIDT1_C0

sum_Full_DTC_DIDT1_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_Full_DTC_DIDT1_C0, type = "text", summary = FALSE, title = "Control Afrer")


############################ 1k Descriptive statistic ################################
DTC_DID_Full <- read.csv("data/1km_Boundary.csv")
DTC_DID_Full <- DTC_DID_Full[,1:23]
DTC_DID_Full <- DTC_DID_Full[DTC_DID_Full$SalePrice < 2500000 & DTC_DID_Full$SalePrice >= 1, ]
#DTC_DID_Full <- DTC_DID_Full[DTC_DID_Full$SalePrice < 5910346 & DTC_DID_Full$SalePrice >= 1, ]
DTC_DID_Full$FinishArea[DTC_DID_Full$FinishArea == 0] <- 449
DTC_DID_Full$LnSalePrice <- log(DTC_DID_Full$SalePrice + 1)
DTC_DID_Full$PricePerSqrft <- (DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full$LnPricePerSqrft <- (DTC_DID_Full$LnSalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & !is.na(DTC_DID_Full$Age) & !is.na(DTC_DID_Full$FinishArea) & !is.na(DTC_DID_Full$LnSalePrice) &  !is.na(DTC_DID_Full$SalePrice),]


DTC_DIDT1 <-  subset(DTC_DID_Full, TimeBin == 1)
DTC_DIDT0 <-  subset(DTC_DID_Full, TimeBin == 0)

DTC_DIDT0_C1 <-  subset(DTC_DIDT0, CoreBin == 1)
DTC_DIDT0_C0 <-  subset(DTC_DIDT0, CoreBin == 0)

DTC_DIDT1_C1 <-  subset(DTC_DIDT1, CoreBin == 1)
DTC_DIDT1_C0 <-  subset(DTC_DIDT1, CoreBin == 0)

df <- DTC_DIDT0_C0

sum_1k_DTC_DIDT0_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_1k_DTC_DIDT0_C0, type = "text", summary = FALSE, title = "Control Before")

df <- DTC_DIDT1_C0

sum_1k_DTC_DIDT1_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_1k_DTC_DIDT1_C0, type = "text", summary = FALSE, title = "Control Afrer")


######################## 3k Descriptive statistic ########################

DTC_DID_Full <- read.csv("data/3km_Boundary.csv")
DTC_DID_Full <- DTC_DID_Full[,1:23]
DTC_DID_Full <- DTC_DID_Full[DTC_DID_Full$SalePrice < 2500000 & DTC_DID_Full$SalePrice >= 1, ]
#DTC_DID_Full <- DTC_DID_Full[DTC_DID_Full$SalePrice < 5910346 & DTC_DID_Full$SalePrice >= 1, ]
DTC_DID_Full$FinishArea[DTC_DID_Full$FinishArea == 0] <- 449
DTC_DID_Full$LnSalePrice <- log(DTC_DID_Full$SalePrice + 1)
DTC_DID_Full$PricePerSqrft <- (DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full$LnPricePerSqrft <- (DTC_DID_Full$LnSalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & !is.na(DTC_DID_Full$Age) & !is.na(DTC_DID_Full$FinishArea) & !is.na(DTC_DID_Full$LnSalePrice) &  !is.na(DTC_DID_Full$SalePrice),]

DTC_DIDT1 <-  subset(DTC_DID_Full, TimeBin == 1)
DTC_DIDT0 <-  subset(DTC_DID_Full, TimeBin == 0)

DTC_DIDT0_C1 <-  subset(DTC_DIDT0, CoreBin == 1)
DTC_DIDT0_C0 <-  subset(DTC_DIDT0, CoreBin == 0)

DTC_DIDT1_C1 <-  subset(DTC_DIDT1, CoreBin == 1)
DTC_DIDT1_C0 <-  subset(DTC_DIDT1, CoreBin == 0)

df <- DTC_DIDT0_C0

sum_3k_DTC_DIDT0_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_3k_DTC_DIDT0_C0, type = "text", summary = FALSE, title = "Control Before")

df <- DTC_DIDT1_C0

sum_3k_DTC_DIDT1_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_3k_DTC_DIDT1_C0, type = "text", summary = FALSE, title = "Control Afrer")




####################### 5k Descriptive statistic #####################

DTC_DID_Full <- read.csv("data/5km_Boundary.csv")
DTC_DID_Full <- DTC_DID_Full[,1:23]
DTC_DID_Full <- DTC_DID_Full[DTC_DID_Full$SalePrice < 2500000 & DTC_DID_Full$SalePrice >= 1, ]
#DTC_DID_Full <- DTC_DID_Full[DTC_DID_Full$SalePrice < 5910346 & DTC_DID_Full$SalePrice >= 1, ]
DTC_DID_Full$FinishArea[DTC_DID_Full$FinishArea == 0] <- 449
DTC_DID_Full$LnSalePrice <- log(DTC_DID_Full$SalePrice + 1)
DTC_DID_Full$PricePerSqrft <- (DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full$LnPricePerSqrft <- (DTC_DID_Full$LnSalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & !is.na(DTC_DID_Full$Age) & !is.na(DTC_DID_Full$FinishArea) & !is.na(DTC_DID_Full$LnSalePrice) &  !is.na(DTC_DID_Full$SalePrice),]



DTC_DIDT1 <-  subset(DTC_DID_Full, TimeBin == 1)
DTC_DIDT0 <-  subset(DTC_DID_Full, TimeBin == 0)

DTC_DIDT0_C1 <-  subset(DTC_DIDT0, CoreBin == 1)
DTC_DIDT0_C0 <-  subset(DTC_DIDT0, CoreBin == 0)

DTC_DIDT1_C1 <-  subset(DTC_DIDT1, CoreBin == 1)
DTC_DIDT1_C0 <-  subset(DTC_DIDT1, CoreBin == 0)


df <- DTC_DIDT0_C0

sum_5k_DTC_DIDT0_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_5k_DTC_DIDT0_C0, type = "text", summary = FALSE, title = "Control Before")

df <- DTC_DIDT1_C0
sum_5k_DTC_DIDT1_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_5k_DTC_DIDT1_C0, type = "text", summary = FALSE, title = "Control Afrer")


######################## 10k Descriptive statistic ########################

DTC_DID_Full <- read.csv("data/10km_Boundary.csv")
DTC_DID_Full <- DTC_DID_Full[,1:23]
DTC_DID_Full <- DTC_DID_Full[DTC_DID_Full$SalePrice < 2500000 & DTC_DID_Full$SalePrice >= 1, ]
#DTC_DID_Full <- DTC_DID_Full[DTC_DID_Full$SalePrice < 5910346 & DTC_DID_Full$SalePrice >= 1, ]
DTC_DID_Full$FinishArea[DTC_DID_Full$FinishArea == 0] <- 449
DTC_DID_Full$LnSalePrice <- log(DTC_DID_Full$SalePrice + 1)
DTC_DID_Full$PricePerSqrft <- (DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full$LnPricePerSqrft <- (DTC_DID_Full$LnSalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & !is.na(DTC_DID_Full$Age) & !is.na(DTC_DID_Full$FinishArea) & !is.na(DTC_DID_Full$LnSalePrice) &  !is.na(DTC_DID_Full$SalePrice),]

DTC_DIDT1 <-  subset(DTC_DID_Full, TimeBin == 1)
DTC_DIDT0 <-  subset(DTC_DID_Full, TimeBin == 0)

DTC_DIDT0_C1 <-  subset(DTC_DIDT0, CoreBin == 1)
DTC_DIDT0_C0 <-  subset(DTC_DIDT0, CoreBin == 0)

DTC_DIDT1_C1 <-  subset(DTC_DIDT1, CoreBin == 1)
DTC_DIDT1_C0 <-  subset(DTC_DIDT1, CoreBin == 0)


df <- DTC_DIDT0_C0

sum_10k_DTC_DIDT0_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_10k_DTC_DIDT0_C0, type = "text", summary = FALSE, title = "Control Before")

df <- DTC_DIDT1_C0

sum_10k_DTC_DIDT1_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_10k_DTC_DIDT1_C0, type = "text", summary = FALSE, title = "Control Afrer")


############### Matched data###############
#Descriptive Stats, Matched Data
DTC_DID_Full <- read.csv("data/Full_Control.csv")
DTC_DID_Full <- DTC_DID_Full[DTC_DID_Full$SalePrice < 2500000 & DTC_DID_Full$SalePrice >= 1, ]
# Filter rows where specified columns are not NA
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & 
                             !is.na(DTC_DID_Full$Age) & 
                             !is.na(DTC_DID_Full$PrcntWhite) & 
                             !is.na(DTC_DID_Full$BAorHigher) & 
                             !is.na(DTC_DID_Full$BuildPreTrt), ]
DTC_DID_Full$FinishArea[DTC_DID_Full$FinishArea == 0] <- 449
DTC_DID_Full$LnSalePrice <- log(DTC_DID_Full$SalePrice + 1)
DTC_DID_Full$PricePerSqrft <- (DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full$LnPricePerSqrft <- log(DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & !is.na(DTC_DID_Full$Age) & !is.na(DTC_DID_Full$FinishArea) & !is.na(DTC_DID_Full$LnSalePrice) &  !is.na(DTC_DID_Full$SalePrice),]
DTC_DID_Full$BAorHigher <- as.numeric(as.character(DTC_DID_Full$BAorHigher))

DTC_DIDT1 <-  subset(DTC_DID_Full, TimeBin == 1)
DTC_DIDT0 <-  subset(DTC_DID_Full, TimeBin == 0)

ps<- glm(CoreBin ~  SalePrice+ Age+ FinishArea+ PrcntWhite+ BAorHigher + BuildPreTrt, data=DTC_DID_Full, family =binomial())

DTC_DID_Full$psvalue <- predict(ps, type = "response")

gps<- gbm(CoreBin ~  SalePrice+ Age+ FinishArea+ PrcntWhite+ BAorHigher+ BuildPreTrt, distribution="bernoulli", data=DTC_DID_Full, n.trees=100, interaction.depth=4, train.fraction= 0.8, shrinkage=0.0005) 

DTC_DID_Full$gpsvalue <-  predict(gps, type = "response")

DTC_DID_Full$CoreBin <- as.factor(DTC_DID_Full$CoreBin)

# Fit a random forest model for propensity score estimation
rf_model <- randomForest(CoreBin ~ SalePrice+ Age + FinishArea + PrcntWhite + BAorHigher + BuildPreTrt, 
                         data = DTC_DID_Full, 
                         ntree = 500,        # Number of trees
                         mtry = 3,           # Number of variables randomly sampled at each split
                         nodesize = 5)       # Minimum size of terminal nodes

# Predict propensity scores for the new dataset
DTC_DID_Full$rf_psvalue <- predict(rf_model, type = "prob")[,2]  # type = "prob" gives class probabilities

#data for rejoining the treatment and control after matching the control
DTC_DID_Full_Treat <- subset(DTC_DID_Full, CoreBin == 1)
DTC_DID_Full_Control <- subset(DTC_DID_Full, CoreBin == 0)



psvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$psvalue), ][1:10000, ]
psvalue_top <- rbind(psvalue_top, DTC_DID_Full_Treat)


gpsvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$gpsvalue), ][1:12500, ]
gpsvalue_top<- rbind(gpsvalue_top, DTC_DID_Full_Treat)


rf_psvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$rf_psvalue), ][1:17000, ]
rf_psvalue_top <- rbind(rf_psvalue_top, DTC_DID_Full_Treat)




###################### PSM Descriptive statistic #########################
DTC_DID_Full<- psvalue_top 


DTC_DIDT1 <-  subset(DTC_DID_Full, TimeBin == 1)
DTC_DIDT0 <-  subset(DTC_DID_Full, TimeBin == 0)

DTC_DIDT0_C1 <-  subset(DTC_DIDT0, CoreBin == 1)
DTC_DIDT0_C0 <-  subset(DTC_DIDT0, CoreBin == 0)

DTC_DIDT1_C1 <-  subset(DTC_DIDT1, CoreBin == 1)
DTC_DIDT1_C0 <-  subset(DTC_DIDT1, CoreBin == 0)

df <- DTC_DIDT0_C0

sum_PSM_DTC_DIDT0_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_1k_DTC_DIDT0_C0, type = "text", summary = FALSE, title = "Control Before")

df <- DTC_DIDT1_C0

sum_PSM_DTC_DIDT1_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_1k_DTC_DIDT1_C0, type = "text", summary = FALSE, title = "Control Afrer")



###################### GBM Descriptive statistic #########################
DTC_DID_Full<- gpsvalue_top 

DTC_DIDT1 <-  subset(DTC_DID_Full, TimeBin == 1)
DTC_DIDT0 <-  subset(DTC_DID_Full, TimeBin == 0)

DTC_DIDT0_C1 <-  subset(DTC_DIDT0, CoreBin == 1)
DTC_DIDT0_C0 <-  subset(DTC_DIDT0, CoreBin == 0)

DTC_DIDT1_C1 <-  subset(DTC_DIDT1, CoreBin == 1)
DTC_DIDT1_C0 <-  subset(DTC_DIDT1, CoreBin == 0)

df <- DTC_DIDT0_C0

sum_GBM_DTC_DIDT0_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_3k_DTC_DIDT0_C0, type = "text", summary = FALSE, title = "Control Before")

df <- DTC_DIDT1_C0

sum_GBM_DTC_DIDT1_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_3k_DTC_DIDT1_C0, type = "text", summary = FALSE, title = "Control Afrer")



###################### RFM Descriptive statistic #########################
 DTC_DID_Full<- rf_psvalue_top 


DTC_DIDT1 <-  subset(DTC_DID_Full, TimeBin == 1)
DTC_DIDT0 <-  subset(DTC_DID_Full, TimeBin == 0)

DTC_DIDT0_C1 <-  subset(DTC_DIDT0, CoreBin == 1)
DTC_DIDT0_C0 <-  subset(DTC_DIDT0, CoreBin == 0)

DTC_DIDT1_C1 <-  subset(DTC_DIDT1, CoreBin == 1)
DTC_DIDT1_C0 <-  subset(DTC_DIDT1, CoreBin == 0)


df <- DTC_DIDT0_C0

sum_RFM_DTC_DIDT0_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_RFM_DTC_DIDT0_C0, type = "text", summary = FALSE, title = "Control Before")

df <- DTC_DIDT1_C0
sum_RFM_DTC_DIDT1_C0 <- data.frame(
  Variable = c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age"),
  N = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) sum(!is.na(x))),
  Mean = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], mean, na.rm = TRUE),
  SD = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], sd, na.rm = TRUE),
  Min = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], min, na.rm = TRUE),
  P25 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.25, na.rm = TRUE)),
  Median = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], median, na.rm = TRUE),
  P75 = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], function(x) quantile(x, 0.75, na.rm = TRUE)),
  Max = sapply(df[c("SalePrice", "LnSalePrice","PricePerSqrft", "LnPricePerSqrft" ,"FinishArea", "Age")], max, na.rm = TRUE)
)

#stargazer(sum_5k_DTC_DIDT1_C0, type = "text", summary = FALSE, title = "Control Afrer")





###########################################Descriptive statistic table production####################################


add_identifiers <- function(df, group_name, time_period) {
  df %>%
    mutate(Group = group_name, Period = time_period)
}

# Apply this to each summary data frame
sum_Treat_DTC_DIDT0_C1 <- add_identifiers(sum_Treat_DTC_DIDT0_C1, "Treatment (DTC)", "T0")
sum_Treat_DTC_DIDT1_C1 <- add_identifiers(sum_Treat_DTC_DIDT1_C1, "Treatment (DTC)", "T1")
sum_1k_DTC_DIDT0_C0 <- add_identifiers(sum_1k_DTC_DIDT0_C0, "1k Control", "T0")
sum_1k_DTC_DIDT1_C0 <- add_identifiers(sum_1k_DTC_DIDT1_C0, "1k Control", "T1")
sum_3k_DTC_DIDT0_C0 <- add_identifiers(sum_3k_DTC_DIDT0_C0, "3k Control", "T0")
sum_3k_DTC_DIDT1_C0 <- add_identifiers(sum_3k_DTC_DIDT1_C0, "3k Control", "T1")
sum_5k_DTC_DIDT0_C0 <- add_identifiers(sum_5k_DTC_DIDT0_C0, "5k Control", "T0")
sum_5k_DTC_DIDT1_C0 <- add_identifiers(sum_5k_DTC_DIDT1_C0, "5k Control", "T1")
sum_10k_DTC_DIDT0_C0 <- add_identifiers(sum_10k_DTC_DIDT0_C0, "10k Control", "T0")
sum_10k_DTC_DIDT1_C0 <- add_identifiers(sum_10k_DTC_DIDT1_C0, "10k Control", "T1")
sum_Full_DTC_DIDT0_C0 <- add_identifiers(sum_Full_DTC_DIDT0_C0, "All Davidson County", "T0")
sum_Full_DTC_DIDT1_C0 <- add_identifiers(sum_Full_DTC_DIDT1_C0, "All Davidson County", "T1")
sum_PSM_DTC_DIDT0_C0 <- add_identifiers(sum_PSM_DTC_DIDT0_C0, "Propensity Score Matching Control", "T0")
sum_PSM_DTC_DIDT1_C0 <- add_identifiers(sum_PSM_DTC_DIDT1_C0, "Propensity Score Matching Control Control", "T1")
sum_GBM_DTC_DIDT0_C0 <- add_identifiers(sum_GBM_DTC_DIDT0_C0, "Generalized Boosted Matching Control", "T0")
sum_GBM_DTC_DIDT1_C0 <- add_identifiers(sum_GBM_DTC_DIDT1_C0, "Generalized Boosted Matching Control", "T1")
sum_RFM_DTC_DIDT0_C0 <- add_identifiers(sum_RFM_DTC_DIDT0_C0, "Random Forest Matching Control", "T0")
sum_RFM_DTC_DIDT1_C0 <- add_identifiers(sum_RFM_DTC_DIDT1_C0, "Random Forest Matching Control", "T1")

# Combine all summaries into one data frame
combined_summary <- bind_rows(
  sum_Treat_DTC_DIDT0_C1, sum_Treat_DTC_DIDT1_C1,
  sum_1k_DTC_DIDT0_C0, sum_1k_DTC_DIDT1_C0,
  sum_3k_DTC_DIDT0_C0, sum_3k_DTC_DIDT1_C0,
  sum_5k_DTC_DIDT0_C0, sum_5k_DTC_DIDT1_C0,
  sum_10k_DTC_DIDT0_C0, sum_10k_DTC_DIDT1_C0,
  sum_Full_DTC_DIDT0_C0, sum_Full_DTC_DIDT1_C0,
  sum_PSM_DTC_DIDT0_C0, sum_PSM_DTC_DIDT1_C0,
  sum_GBM_DTC_DIDT0_C0, sum_GBM_DTC_DIDT1_C0,
  sum_RFM_DTC_DIDT0_C0, sum_RFM_DTC_DIDT1_C0)

# Pivot the data to have T0 and T1 in separate columns
summary_Median <- combined_summary %>%
  filter(Variable == "SalePrice") %>%  # Filter to include only "SalePrice" if only that is needed
  select(Group, Period, Median) %>%
  pivot_wider(names_from = Period, values_from = Median, names_prefix = "Median_SalePrice")

# Display the summary with stargazer
#stargazer(summary_Median, type = "text", summary = FALSE, title = "Median Sale Price by Group and Period")


summary_Mean <- combined_summary %>%
  filter(Variable == "SalePrice") %>%  # Filter to include only "SalePrice" if only that is needed
  select(Group, Period, Mean) %>%
  pivot_wider(names_from = Period, values_from = Mean, names_prefix = "Mean_SalePrice")

# Display the summary with stargazer
stargazer(summary_Mean, summary = FALSE, title = "Mean Sale Price by Group and Period") # , type = "latex"




# Pivot the data to have T0 and T1 in separate columns
summary_Median1 <- combined_summary %>%
  filter(Variable == 'PricePerSqrft') %>%  # Filter to include only "SalePrice" if only that is needed
  select(Group, Period, Median) %>%
  pivot_wider(names_from = Period, values_from = Median, names_prefix = "Median_PricePerSqrft")

# Display the summary with stargazer
#stargazer(summary_Median1, type = "text", summary = FALSE, title = "Median Price Per Sqrft by Group and Period")


summary_Mean1 <- combined_summary %>%
  filter(Variable == 'SalePrice') %>%  # Filter to include only "SalePrice" if only that is needed
  select(Group, Period, Mean) %>%
  pivot_wider(names_from = Period, values_from = Mean, names_prefix = "Mean_PricePerSqrft")

# Display the summary with stargazer
stargazer(summary_Mean1,summary = FALSE, title = "Mean Sale Price by Group and Period",digits=0)# , type = "latex"



summary_Combo <- combined_summary %>%
  filter(Variable == 'SalePrice') %>%  # Filter to include only "SalePrice" if only that is needed
  select(Group, Period, Mean,N,P25,Median,P75,SD) %>%
  pivot_wider(names_from = Period, values_from = c(N,Mean,SD,P25,Median,P75), names_prefix = "Mean_PricePerSqrft")

# Display the summary with stargazer
stargazer(summary_Combo,  summary = FALSE, title = "Mean Sale Price Per Square Foot by Group and Period")# , type = "latex"




summary_Combo1 <- combined_summary %>%
  filter(Variable == 'PricePerSqrft') %>%  # Filter to include only "SalePrice" if only that is needed
  select(Group, Period, Mean,N,P25,Median,P75,SD) %>%
  pivot_wider(names_from = Period, values_from = c(N,Mean,SD,P25,Median,P75), names_prefix = "Mean_PricePerSqrft")

# Display the summary with stargazer
stargazer(summary_Combo1, summary = FALSE, title = "Mean Sale Price Per Square Foot by Group and Period") # , type = "latex"


```

# Balance Tables

## Balance Tables by Geographic Controls 

Balance tables are provided for geographic control groups in the order (1km, 3km, 5km, 10km).

```{r}
###################Additional Balance Tables###############


#loading the data:
DID1k <- read.csv("data/1km_Boundary.csv")
DID1k <- DID1k[DID1k$SalePrice < 2500000 & DID1k$SalePrice >= 1, ]
DID1k$FinishArea[DID1k$FinishArea == 0] <- 449
DID1k$LnSalePrice <- log(DID1k$SalePrice + 1)
DID1k$PricePerSqrft <- (DID1k$SalePrice/(DID1k$FinishArea))
DID1k$LnPricePerSqrft <- log((DID1k$SalePrice/(DID1k$FinishArea)))
DID1k <- DID1k[!is.na(DID1k$CoreBin) & !is.na(DID1k$Age) & !is.na(DID1k$FinishArea) & !is.na(DID1k$LnSalePrice) &  !is.na(DID1k$SalePrice),]

#3k DID 
DID3k <- read.csv("data/3km_Boundary.csv")
DID3k <- DID3k[DID3k$SalePrice < 2500000 & DID3k$SalePrice >= 1, ]
DID3k$FinishArea[DID3k$FinishArea == 0] <- 449
DID3k$LnSalePrice <- log(DID3k$SalePrice + 1)
DID3k$PricePerSqrft <- (DID3k$SalePrice/(DID3k$FinishArea))
DID3k$LnPricePerSqrft <- log(DID3k$SalePrice/(DID3k$FinishArea))
DID3k <- DID3k[!is.na(DID3k$CoreBin) & !is.na(DID3k$Age) & !is.na(DID3k$FinishArea) & !is.na(DID3k$LnSalePrice) &  !is.na(DID3k$SalePrice),]

#5k DID 
DID5k <- read.csv("data/5km_Boundary.csv")
DID5k <- DID5k[DID5k$SalePrice < 2500000 & DID5k$SalePrice >= 1, ]
DID5k$FinishArea[DID5k$FinishArea == 0] <- 449
DID5k$LnSalePrice <- log(DID5k$SalePrice + 1)
DID5k$PricePerSqrft <- (DID5k$SalePrice/(DID5k$FinishArea))
DID5k$LnPricePerSqrft <- log(DID5k$SalePrice/(DID5k$FinishArea))
DID5k <- DID5k[!is.na(DID5k$CoreBin) & !is.na(DID5k$Age) & !is.na(DID5k$PrcntWhite) & 
!is.na(DID5k$BAorHigher) & !is.na(DID5k$BuildPreTrt), ]
#10k DID 
DID10k <- read.csv("data/10km_Boundary.csv")
DID10k <- DID10k[DID10k$SalePrice < 2500000 & DID10k$SalePrice >= 1, ]
DID10k$FinishArea[DID10k$FinishArea == 0] <- 449
DID10k$LnSalePrice <- log(DID10k$SalePrice + 1)
DID10k$PricePerSqrft <- (DID10k$SalePrice/(DID10k$FinishArea))
DID10k$LnPricePerSqrft <- log(DID10k$SalePrice/(DID10k$FinishArea))
DID10k <- DID10k[!is.na(DID10k$CoreBin) & !is.na(DID10k$Age) & !is.na(DID10k$PrcntWhite) & 
!is.na(DID10k$BAorHigher) & !is.na(DID10k$BuildPreTrt), ]

# Treated vs Untreated (1km boundary)
m.out1 <- matchit(CoreBin ~   Age+ FinishArea+ PrcntWhite+ BAorHigher + BuildPreTrt, data = DID1k,
                 method = NULL, distance = "glm")
summary(m.out1)

# Treated vs Untreated (3km boundary)
m.out3 <- matchit(CoreBin ~  Age+ FinishArea+ PrcntWhite+ BAorHigher + BuildPreTrt, data = DID3k,
                 method = NULL, distance = "glm")
summary(m.out3)

# Treated vs Untreated (5km boundary)
m.out5 <- matchit(CoreBin ~  Age+ FinishArea+ PrcntWhite+ BAorHigher + BuildPreTrt, data = DID5k,
                 method = NULL, distance = "glm")
summary(m.out5)


# Treated vs Untreated (10km boundary)
m.out10 <- matchit(CoreBin ~  Age+ FinishArea+ PrcntWhite+ BAorHigher + BuildPreTrt, data = DID10k,
                 method = NULL, distance = "glm")
summary(m.out10)
```

## Balance Tables by Matched Controls 

Balance tables are provided for matched control groups in the order (PSM, GBM, RFM).

```{r}
################# Matching, balance tables    #################


DTC_DID_Full <- read.csv("data/Full_Control.csv")
DTC_DID_Full <- DTC_DID_Full[DTC_DID_Full$SalePrice < 2500000 & DTC_DID_Full$SalePrice >= 1, ]
# Filter rows where specified columns are not NA
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & 
                             !is.na(DTC_DID_Full$Age) & 
                             !is.na(DTC_DID_Full$PrcntWhite) & 
                             !is.na(DTC_DID_Full$BAorHigher) & 
                             !is.na(DTC_DID_Full$BuildPreTrt), ]
DTC_DID_Full$FinishArea[DTC_DID_Full$FinishArea == 0] <- 449
DTC_DID_Full$LnSalePrice <- log(DTC_DID_Full$SalePrice + 1)
DTC_DID_Full$PricePerSqrft <- (DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full$LnPricePerSqrft <- log(DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & !is.na(DTC_DID_Full$Age) & !is.na(DTC_DID_Full$FinishArea) & !is.na(DTC_DID_Full$LnSalePrice) &  !is.na(DTC_DID_Full$SalePrice),]
DTC_DID_Full$BAorHigher <- as.numeric(as.character(DTC_DID_Full$BAorHigher))

DTC_DIDT1 <-  subset(DTC_DID_Full, TimeBin == 1)
DTC_DIDT0 <-  subset(DTC_DID_Full, TimeBin == 0)

ps<- glm(CoreBin ~   Age+ FinishArea+ PrcntWhite+ BAorHigher + BuildPreTrt, data=DTC_DID_Full, family =binomial())
summary(ps)

DTC_DID_Full$psvalue <- predict(ps, type = "response")

gps<- gbm(CoreBin ~   Age+ FinishArea+ PrcntWhite+ BAorHigher+ BuildPreTrt, distribution="bernoulli", data=DTC_DID_Full, n.trees=100, interaction.depth=4, train.fraction= 0.8, shrinkage=0.0005) 
summary(gps) 

DTC_DID_Full$gpsvalue <-  predict(gps, type = "response")

DTC_DID_Full$CoreBin <- as.factor(DTC_DID_Full$CoreBin)

# Fit a random forest model for propensity score estimation
rf_model <- randomForest(CoreBin ~  Age + FinishArea + PrcntWhite + BAorHigher + BuildPreTrt, 
                         data = DTC_DID_Full, 
                         ntree = 500,        # Number of trees
                         mtry = 3,           # Number of variables randomly sampled at each split
                         nodesize = 5)       # Minimum size of terminal nodes

# Predict propensity scores for the new dataset
DTC_DID_Full$rf_psvalue <- predict(rf_model, type = "prob")[,2]  # type = "prob" gives class probabilities

#data for rejoining the treatment and control after matching the control
DTC_DID_Full_Treat <- subset(DTC_DID_Full, CoreBin == 1)
DTC_DID_Full_Control <- subset(DTC_DID_Full, CoreBin == 0)

# No matching; constructing a pre-match matchit object
m.out0 <- matchit(CoreBin ~  Age+ FinishArea+ PrcntWhite+ BAorHigher + BuildPreTrt, data = DTC_DID_Full,
                 method = NULL, distance = "glm")
# Checking balance prior to matching
summary(m.out0)


psvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$psvalue), ][1:10000, ]
psvalue_top <- rbind(psvalue_top, DTC_DID_Full_Treat)
m.out1 <- matchit(CoreBin ~  Age+ FinishArea+ PrcntWhite+ BAorHigher + BuildPreTrt, data = psvalue_top,
                 method = NULL, distance = "glm")
# Checking balance after to matching
summary(m.out1)

gpsvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$gpsvalue), ][1:12500, ]
gpsvalue_top<- rbind(gpsvalue_top, DTC_DID_Full_Treat)
m.out2 <- matchit(CoreBin ~  Age+ FinishArea+ PrcntWhite+ BAorHigher + BuildPreTrt, data = gpsvalue_top,
                 method = NULL, distance = "glm")
# Checking balance after to matching
summary(m.out2)


rf_psvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$rf_psvalue), ][1:17000, ]
rf_psvalue_top <- rbind(rf_psvalue_top, DTC_DID_Full_Treat)
m.out3 <- matchit(CoreBin ~  Age+ FinishArea+ PrcntWhite+ BAorHigher + BuildPreTrt, data = rf_psvalue_top,
                 method = NULL, distance = "glm")
# Checking balance after to matching
summary(m.out3)


```

# Event Studies

## Creating Event Studies Using Geographic Controls

```{r}

################### creating event study using geographic controls ########################
#Data creation
DID1k <- read.csv("data/1km_Boundary.csv")
DID1k <- DID1k[,1:25]
DID1k <- DID1k[DID1k$SalePrice < 2500000 & DID1k$SalePrice >= 1, ]
DID1k$FinishArea[DID1k$FinishArea == 0] <- 449
DID1k$LnSalePrice <- log(DID1k$SalePrice + 1)
DID1k$PricePerSqrft <- (DID1k$SalePrice/(DID1k$FinishArea))
DID1k$LnPricePerSqrft <- log((DID1k$SalePrice/(DID1k$FinishArea)))
DID1k <- DID1k[!is.na(DID1k$CoreBin) & !is.na(DID1k$Age) & !is.na(DID1k$FinishArea) & !is.na(DID1k$LnSalePrice) &  !is.na(DID1k$SalePrice),]


#3k DID 
DID3k <- read.csv("data/3km_Boundary.csv")
DID3k <- DID3k[DID3k$SalePrice < 2500000 & DID3k$SalePrice >= 1, ]
DID3k$FinishArea[DID3k$FinishArea == 0] <- 449
DID3k$LnSalePrice <- log(DID3k$SalePrice + 1)
DID3k$PricePerSqrft <- (DID3k$SalePrice/(DID3k$FinishArea))
DID3k$LnPricePerSqrft <- log(DID3k$SalePrice/(DID3k$FinishArea))
DID3k <- DID3k[!is.na(DID3k$CoreBin) & !is.na(DID3k$Age) & !is.na(DID3k$FinishArea) & !is.na(DID3k$LnSalePrice) &  !is.na(DID3k$SalePrice),]


#5k DID 
DID5k <- read.csv("data/5km_Boundary.csv")
DID5k <- DID5k[,1:25]
DID5k <- DID5k[DID5k$SalePrice < 2500000 & DID5k$SalePrice >= 1, ]
DID5k$FinishArea[DID5k$FinishArea == 0] <- 449
DID5k$LnSalePrice <- log(DID5k$SalePrice + 1)
DID5k$PricePerSqrft <- (DID5k$SalePrice/(DID5k$FinishArea))
DID5k$LnPricePerSqrft <- log(DID5k$SalePrice/(DID5k$FinishArea))
DID5k <- DID5k[!is.na(DID5k$CoreBin) & !is.na(DID5k$Age) & !is.na(DID5k$FinishArea) & !is.na(DID5k$LnSalePrice) &  !is.na(DID5k$SalePrice),]


#10k DID 
DID10k <- read.csv("data/10km_Boundary.csv")
DID10k <- DID10k[DID10k$SalePrice < 2500000 & DID10k$SalePrice >= 1, ]
DID10k$FinishArea[DID10k$FinishArea == 0] <- 449
DID10k$LnSalePrice <- log(DID10k$SalePrice + 1)
DID10k$PricePerSqrft <- (DID10k$SalePrice/(DID10k$FinishArea))
DID10k$LnPricePerSqrft <- log(DID10k$SalePrice/(DID10k$FinishArea))
DID10k <- DID10k[!is.na(DID10k$CoreBin) & !is.na(DID10k$Age) & !is.na(DID10k$FinishArea) & !is.na(DID10k$LnSalePrice) &  !is.na(DID10k$SalePrice),]

################### creating event studies ########################

DID1k$TimeToTreat  <-  (ifelse(DID1k$CoreBin==1, as.numeric(DID1k$Year) - 2010, 0))


mod_twfe = feols(LnSalePrice ~ i(TimeToTreat, CoreBin, ref = -1) + ## Our key interaction: time × treatment status
		  FinishArea + Age |                    ## Other controls
		  Tract + Year,                             ## FEs
		 #cluster = ~Tract,                          ## Clustered SEs
		 data = DID1k)

iplot(mod_twfe, ci_level = 0.99, 
      xlab = 'Time to treatment',
      main = 'Log(Sale Price) 1 km control: Staggered treatment (TWFE)')




DID3k$TimeToTreat  <-  (ifelse(DID3k$CoreBin==1, as.numeric(DID3k$Year) - 2010, 0))


mod_twfe = feols(LnSalePrice ~ i(TimeToTreat, CoreBin, ref = -1) + ## Our key interaction: time × treatment status
		  FinishArea + Age |                    ## Other controls
		  Tract + Year,                             ## FEs
		 #cluster = ~Tract,                          ## Clustered SEs
		 data = DID3k)

iplot(mod_twfe, ci_level = 0.99, 
      xlab = 'Time to treatment',
      main = 'Log(Sale Price) 3 km control: Staggered treatment (TWFE)')








DID5k$TimeToTreat  <-  (ifelse(DID5k$CoreBin==1, as.numeric(DID5k$Year) - 2010, 0))


mod_twfe = feols(LnSalePrice ~ i(TimeToTreat, CoreBin, ref = -1) + ## Our key interaction: time × treatment status
		  FinishArea + Age |                    ## Other controls
		  Tract + Year,                             ## FEs
		 #cluster = ~Tract,                          ## Clustered SEs
		 data = DID5k)

iplot(mod_twfe, ci_level = 0.99, 
      xlab = 'Time to treatment',
      main = 'Log(Sale Price) 5 km control: Staggered treatment (TWFE)')





DID10k$TimeToTreat  <-  (ifelse(DID10k$CoreBin==1, as.numeric(DID10k$Year) - 2010, 0))


mod_twfe = feols(LnSalePrice ~ i(TimeToTreat, CoreBin, ref = -1) + ## Our key interaction: time × treatment status
		  FinishArea + Age |                    ## Other controls
		  Tract + Year,                             ## FEs
		 #cluster = ~Tract,                          ## Clustered SEs
		 data = DID10k)

iplot(mod_twfe, ci_level = 0.99, 
      xlab = 'Time to treatment',
      main = 'Log(Sale Price) 10 km control: Staggered treatment (TWFE)') + theme(panel.background = element_blank())

```

## Creating Event Studies Using Matched Controls

```{r}

################### creating event study using matched controls ########################
#Data creation

DTC_DID_Full <- read.csv("data/Full_Control.csv")
DTC_DID_Full <- DTC_DID_Full[DTC_DID_Full$SalePrice < 2500000 & DTC_DID_Full$SalePrice >= 1, ]
# Filter rows where specified columns are not NA
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & 
                             !is.na(DTC_DID_Full$Age) & 
                             !is.na(DTC_DID_Full$PrcntWhite) & 
                             !is.na(DTC_DID_Full$BAorHigher) & 
                             !is.na(DTC_DID_Full$BuildPreTrt), ]
DTC_DID_Full$FinishArea[DTC_DID_Full$FinishArea == 0] <- 449
DTC_DID_Full$LnSalePrice <- log(DTC_DID_Full$SalePrice + 1)
DTC_DID_Full$PricePerSqrft <- (DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full$LnPricePerSqrft <- log(DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & !is.na(DTC_DID_Full$Age) & !is.na(DTC_DID_Full$FinishArea) & !is.na(DTC_DID_Full$LnSalePrice) &  !is.na(DTC_DID_Full$SalePrice),]
DTC_DID_Full$BAorHigher <- as.numeric(as.character(DTC_DID_Full$BAorHigher))

DTC_DIDT1 <-  subset(DTC_DID_Full, TimeBin == 1)
DTC_DIDT0 <-  subset(DTC_DID_Full, TimeBin == 0)

ps<- glm(CoreBin ~  SalePrice+ Age+ FinishArea+ PrcntWhite+ BAorHigher + BuildPreTrt, data=DTC_DID_Full, family =binomial())

DTC_DID_Full$psvalue <- predict(ps, type = "response")

gps<- gbm(CoreBin ~  SalePrice+ Age+ FinishArea+ PrcntWhite+ BAorHigher+ BuildPreTrt, distribution="bernoulli", data=DTC_DID_Full, n.trees=100, interaction.depth=4, train.fraction= 0.8, shrinkage=0.0005) 

DTC_DID_Full$gpsvalue <-  predict(gps, type = "response")

DTC_DID_Full$CoreBin <- as.factor(DTC_DID_Full$CoreBin)

# Fit a random forest model for propensity score estimation
rf_model <- randomForest(CoreBin ~ SalePrice+ Age + FinishArea + PrcntWhite + BAorHigher + BuildPreTrt, 
                         data = DTC_DID_Full, 
                         ntree = 500,        # Number of trees
                         mtry = 3,           # Number of variables randomly sampled at each split
                         nodesize = 5)       # Minimum size of terminal nodes

# Predict propensity scores for the new dataset
DTC_DID_Full$rf_psvalue <- predict(rf_model, type = "prob")[,2]  # type = "prob" gives class probabilities

#data for rejoining the treatment and control after matching the control
DTC_DID_Full_Treat <- subset(DTC_DID_Full, CoreBin == 1)
DTC_DID_Full_Control <- subset(DTC_DID_Full, CoreBin == 0)


psvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$psvalue), ][1:10000, ]
psvalue_top <- rbind(psvalue_top, DTC_DID_Full_Treat)


gpsvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$gpsvalue), ][1:12500, ]
gpsvalue_top<- rbind(gpsvalue_top, DTC_DID_Full_Treat)


rf_psvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$rf_psvalue), ][1:17000, ]
rf_psvalue_top <- rbind(rf_psvalue_top, DTC_DID_Full_Treat)



################### creating event studies ########################

psvalue_top$TimeToTreat  <-  (ifelse(psvalue_top$CoreBin==1, as.numeric(psvalue_top$Year) - 2010, 0))

psvalue_top$CoreBin <- as.numeric(as.character(psvalue_top$CoreBin))

mod_twfe = feols(LnSalePrice ~ i(TimeToTreat, CoreBin, ref = -1) + ## Our key interaction: time × treatment status
		  FinishArea + Age |                    ## Other controls
		  Tract + Year,                             ## FEs
		 #cluster = ~Tract,                          ## Clustered SEs
		 data = psvalue_top)

iplot(mod_twfe, ci_level = 0.99, 
      xlab = 'Years to treatment',
      main = 'Propensity Score Matching, Log(Sale Price) Event Study')




gpsvalue_top$TimeToTreat  <-  (ifelse(gpsvalue_top$CoreBin==1, as.numeric(gpsvalue_top$Year) - 2010, 0))

gpsvalue_top$CoreBin <- as.numeric(as.character(gpsvalue_top$CoreBin))

mod_twfe = feols(LnSalePrice ~ i(TimeToTreat, CoreBin, ref = -1) + ## Our key interaction: time × treatment status
		  FinishArea + Age |                    ## Other controls
		  Tract + Year,                             ## FEs
		 #cluster = ~Tract,                          ## Clustered SEs
		 data = gpsvalue_top)

iplot(mod_twfe, ci_level = 0.99, 
      xlab = 'Years to treatment',
      main = 'Generalized Boosted Matching, Log(Sale Price) Event Study')



rf_psvalue_top$TimeToTreat  <-  (ifelse(rf_psvalue_top$CoreBin==1, as.numeric(rf_psvalue_top$Year) - 2010, 0))

rf_psvalue_top$CoreBin <- as.numeric(as.character(rf_psvalue_top$CoreBin))

mod_twfe = feols(LnSalePrice ~ i(TimeToTreat, CoreBin, ref = -1) + ## Our key interaction: time × treatment status
		  FinishArea + Age |                    ## Other controls
		  Tract + Year,                             ## FEs
		 #cluster = ~Tract,                          ## Clustered SEs
		 data = rf_psvalue_top)

iplot(mod_twfe, ci_level = 0.99, 
      xlab = 'Years to treatment',
      main = 'Random Forest Matching, Log(Sale Price) Event Study')



```

# Estimating Average Treatment Effect (ATE)

## DiD Regressions with Log SalePrice and Log SalePriceper per Square Foot Using Geographic Controls

```{r results = "asis"}
#Difference-in-Differences LnSalePrice and LnSalePriceper sqr foot with geographic controls
#1k DID 
DID1k <- read.csv("data/1km_Boundary.csv")
DID1k <- DID1k[,1:25]
DID1k <- DID1k[DID1k$SalePrice < 2500000 & DID1k$SalePrice >= 1, ]
DID1k$FinishArea[DID1k$FinishArea == 0] <- 449
DID1k$LnSalePrice <- log(DID1k$SalePrice + 1)
DID1k$PricePerSqrft <- (DID1k$SalePrice/(DID1k$FinishArea))
DID1k$LnPricePerSqrft <- log((DID1k$SalePrice/(DID1k$FinishArea)))
DID1k <- DID1k[!is.na(DID1k$CoreBin) & !is.na(DID1k$Age) & !is.na(DID1k$FinishArea) & !is.na(DID1k$LnSalePrice) &  !is.na(DID1k$SalePrice),]

DIDmodel1 <- lm(LnSalePrice ~ CoreBin*TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = DID1k)
DIDmodel1.1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = DID1k)


#3k DID 
DID3k <- read.csv("data/3km_Boundary.csv")
DID3k <- DID3k[DID3k$SalePrice < 2500000 & DID3k$SalePrice >= 1, ]
DID3k$FinishArea[DID3k$FinishArea == 0] <- 449
DID3k$LnSalePrice <- log(DID3k$SalePrice + 1)
DID3k$PricePerSqrft <- (DID3k$SalePrice/(DID3k$FinishArea))
DID3k$LnPricePerSqrft <- log(DID3k$SalePrice/(DID3k$FinishArea))
DID3k <- DID3k[!is.na(DID3k$CoreBin) & !is.na(DID3k$Age) & !is.na(DID3k$FinishArea) & !is.na(DID3k$LnSalePrice) &  !is.na(DID3k$SalePrice),]

DIDmodel3 <- lm(LnSalePrice ~ CoreBin*TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = DID3k)
DIDmodel3.1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = DID3k)



#5k DID 
DID5k <- read.csv("data/5km_Boundary.csv")
DID5k <- DID5k[,1:25]
DID5k <- DID5k[DID5k$SalePrice < 2500000 & DID5k$SalePrice >= 1, ]
DID5k$FinishArea[DID5k$FinishArea == 0] <- 449
DID5k$LnSalePrice <- log(DID5k$SalePrice + 1)
DID5k$PricePerSqrft <- (DID5k$SalePrice/(DID5k$FinishArea))
DID5k$LnPricePerSqrft <- log(DID5k$SalePrice/(DID5k$FinishArea))
DID5k <- DID5k[!is.na(DID5k$CoreBin) & !is.na(DID5k$Age) & !is.na(DID5k$FinishArea) & !is.na(DID5k$LnSalePrice) &  !is.na(DID5k$SalePrice),]

DIDmodel5 <- lm(log(SalePrice) ~ CoreBin * TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = DID5k)
DIDmodel5.1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = DID5k)


#10k DID 
DID10k <- read.csv("data/10km_Boundary.csv")
DID10k <- DID10k[DID10k$SalePrice < 2500000 & DID10k$SalePrice >= 1, ]
DID10k$FinishArea[DID10k$FinishArea == 0] <- 449
DID10k$LnSalePrice <- log(DID10k$SalePrice + 1)
DID10k$PricePerSqrft <- (DID10k$SalePrice/(DID10k$FinishArea))
DID10k$LnPricePerSqrft <- log(DID10k$SalePrice/(DID10k$FinishArea))
DID10k <- DID10k[!is.na(DID10k$CoreBin) & !is.na(DID10k$Age) & !is.na(DID10k$FinishArea) & !is.na(DID10k$LnSalePrice) &  !is.na(DID10k$SalePrice),]


DIDmodel10 <- lm(log(SalePrice) ~ CoreBin * TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = DID10k)
DIDmodel10.1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = DID10k)


stargazer(DIDmodel1,DIDmodel3,DIDmodel5, DIDmodel10) #,type="text" )
stargazer(DIDmodel1.1,DIDmodel3.1,DIDmodel5.1, DIDmodel10.1) #,type="text" )

```

## DiD Regressions with Log SalePrice and Log SalePriceper per Square Foot Using Matched Controls

```{r results = "asis"}
#########difference in differencess, LnSalePrice and LnSalePriceper sqr foot with Matched  controls#######


DTC_DID_Full <- read.csv("data/Full_Control.csv")
DTC_DID_Full <- DTC_DID_Full[DTC_DID_Full$SalePrice < 2500000 & DTC_DID_Full$SalePrice >= 1, ]
# Filter rows where specified columns are not NA
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & 
                             !is.na(DTC_DID_Full$Age) & 
                             !is.na(DTC_DID_Full$PrcntWhite) & 
                             !is.na(DTC_DID_Full$BAorHigher) & 
                             !is.na(DTC_DID_Full$BuildPreTrt), ]
DTC_DID_Full$FinishArea[DTC_DID_Full$FinishArea == 0] <- 449
DTC_DID_Full$LnSalePrice <- log(DTC_DID_Full$SalePrice + 1)
DTC_DID_Full$PricePerSqrft <- (DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full$LnPricePerSqrft <- log(DTC_DID_Full$SalePrice/(DTC_DID_Full$FinishArea))
DTC_DID_Full <- DTC_DID_Full[!is.na(DTC_DID_Full$CoreBin) & !is.na(DTC_DID_Full$Age) & !is.na(DTC_DID_Full$FinishArea) & !is.na(DTC_DID_Full$LnSalePrice) &  !is.na(DTC_DID_Full$SalePrice),]
DTC_DID_Full$BAorHigher <- as.numeric(as.character(DTC_DID_Full$BAorHigher))

DTC_DIDT1 <-  subset(DTC_DID_Full, TimeBin == 1)
DTC_DIDT0 <-  subset(DTC_DID_Full, TimeBin == 0)

ps<- glm(CoreBin ~  SalePrice+ Age+ FinishArea+ PrcntWhite+ BAorHigher + BuildPreTrt, data=DTC_DID_Full, family =binomial())

DTC_DID_Full$psvalue <- predict(ps, type = "response")

gps<- gbm(CoreBin ~  SalePrice+ Age+ FinishArea+ PrcntWhite+ BAorHigher+ BuildPreTrt, distribution="bernoulli", data=DTC_DID_Full, n.trees=100, interaction.depth=4, train.fraction= 0.8, shrinkage=0.0005) 

DTC_DID_Full$gpsvalue <-  predict(gps, type = "response")

DTC_DID_Full$CoreBin <- as.factor(DTC_DID_Full$CoreBin)

# Fit a random forest model for propensity score estimation
rf_model <- randomForest(CoreBin ~ SalePrice+ Age + FinishArea + PrcntWhite + BAorHigher + BuildPreTrt, 
                         data = DTC_DID_Full, 
                         ntree = 500,        # Number of trees
                         mtry = 3,           # Number of variables randomly sampled at each split
                         nodesize = 5)       # Minimum size of terminal nodes

# Predict propensity scores for the new dataset
DTC_DID_Full$rf_psvalue <- predict(rf_model, type = "prob")[,2]  # type = "prob" gives class probabilities

#data for rejoining the treatment and control after matching the control
DTC_DID_Full_Treat <- subset(DTC_DID_Full, CoreBin == 1)
DTC_DID_Full_Control <- subset(DTC_DID_Full, CoreBin == 0)


psvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$psvalue), ][1:10000, ]
psvalue_top <- rbind(psvalue_top, DTC_DID_Full_Treat)


gpsvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$gpsvalue), ][1:12500, ]
gpsvalue_top<- rbind(gpsvalue_top, DTC_DID_Full_Treat)


rf_psvalue_top <- DTC_DID_Full_Control[order(-DTC_DID_Full_Control$rf_psvalue), ][1:17000, ]
rf_psvalue_top <- rbind(rf_psvalue_top, DTC_DID_Full_Treat)


#Full DiD regressions with improved sample selection

DIDmodelmps <- lm(log(SalePrice) ~ CoreBin*TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = psvalue_top)
DIDmodelmgps <- lm(log(SalePrice) ~ CoreBin*TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = gpsvalue_top)
DIDmodelmrf <- lm(log(SalePrice) ~ CoreBin*TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = rf_psvalue_top)


DIDmodelmps.1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin  + Age + factor(Tract) + factor(Year), data = psvalue_top)
DIDmodelmgps.1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin  + Age + factor(Tract) + factor(Year), data = gpsvalue_top)
DIDmodelmrf.1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin  + Age + factor(Tract) + factor(Year), data = rf_psvalue_top)

stargazer(DIDmodelmps,DIDmodelmgps,DIDmodelmrf)#,type="text" )
stargazer(DIDmodelmps.1,DIDmodelmgps.1,DIDmodelmrf.1)#,type="text" )

```


## Temporally Segmented DiD Regressions by Time Period (2010-2015, 2016-2023), with Geographic Samples

```{r results = "asis"}
#Difference-in-Differences by time period (2010-2015, 2016-2023), with geographic controlss

################## 2010-2015 Difference-in-Differences LnSalePrice and LnSalePriceper sqr foot ################## 
#1k DID 
DID1k <- read.csv("data/1km_Boundary.csv")
DID1k <- DID1k[,1:25]
DID1k <- DID1k[DID1k$SalePrice < 2500000 & DID1k$SalePrice >= 1, ]
DID1k$FinishArea[DID1k$FinishArea == 0] <- 449
DID1k$LnSalePrice <- log(DID1k$SalePrice + 1)
DID1k$PricePerSqrft <- (DID1k$SalePrice/(DID1k$FinishArea))
DID1k$LnPricePerSqrft <- log((DID1k$SalePrice/(DID1k$FinishArea)))
DID1k <- DID1k[!is.na(DID1k$CoreBin) & !is.na(DID1k$Age) & !is.na(DID1k$FinishArea) & !is.na(DID1k$LnSalePrice) &  !is.na(DID1k$SalePrice),]
DID1k <- DID1k[!(DID1k$Year > 2016), ]

DIDmodel1 <- lm(LnSalePrice ~ CoreBin*TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = DID1k)
DIDmodel1.1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = DID1k)


#3k DID 
DID3k <- read.csv("data/3km_Boundary.csv")
DID3k <- DID3k[DID3k$SalePrice < 2500000 & DID3k$SalePrice >= 1, ]
DID3k$FinishArea[DID3k$FinishArea == 0] <- 449
DID3k$LnSalePrice <- log(DID3k$SalePrice + 1)
DID3k$PricePerSqrft <- (DID3k$SalePrice/(DID3k$FinishArea))
DID3k$LnPricePerSqrft <- log(DID3k$SalePrice/(DID3k$FinishArea))
DID3k <- DID3k[!is.na(DID3k$CoreBin) & !is.na(DID3k$Age) & !is.na(DID3k$FinishArea) & !is.na(DID3k$LnSalePrice) &  !is.na(DID3k$SalePrice),]
DID3k <- DID3k[!(DID3k$Year > 2016), ]


DIDmodel3 <- lm(LnSalePrice ~ CoreBin*TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = DID3k)
DIDmodel3.1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = DID3k)



#5k DID 
DID5k <- read.csv("data/5km_Boundary.csv")
DID5k <- DID5k[,1:25]
DID5k <- DID5k[DID5k$SalePrice < 2500000 & DID5k$SalePrice >= 1, ]
DID5k$FinishArea[DID5k$FinishArea == 0] <- 449
DID5k$LnSalePrice <- log(DID5k$SalePrice + 1)
DID5k$PricePerSqrft <- (DID5k$SalePrice/(DID5k$FinishArea))
DID5k$LnPricePerSqrft <- log(DID5k$SalePrice/(DID5k$FinishArea))
DID5k <- DID5k[!is.na(DID5k$CoreBin) & !is.na(DID5k$Age) & !is.na(DID5k$FinishArea) & !is.na(DID5k$LnSalePrice) &  !is.na(DID5k$SalePrice),]
DID5k <- DID5k[!(DID5k$Year > 2016), ]


DIDmodel5 <- lm(log(SalePrice) ~ CoreBin * TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = DID5k)
DIDmodel5.1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = DID5k)


#10k DID 
DID10k <- read.csv("data/10km_Boundary.csv")
DID10k <- DID10k[DID10k$SalePrice < 2500000 & DID10k$SalePrice >= 1, ]
DID10k$FinishArea[DID10k$FinishArea == 0] <- 449
DID10k$LnSalePrice <- log(DID10k$SalePrice + 1)
DID10k$PricePerSqrft <- (DID10k$SalePrice/(DID10k$FinishArea))
DID10k$LnPricePerSqrft <- log(DID10k$SalePrice/(DID10k$FinishArea))
DID10k <- DID10k[!is.na(DID10k$CoreBin) & !is.na(DID10k$Age) & !is.na(DID10k$FinishArea) & !is.na(DID10k$LnSalePrice) &  !is.na(DID10k$SalePrice),]
DID10k <- DID10k[!(DID10k$Year > 2016), ]


DIDmodel10 <- lm(log(SalePrice) ~ CoreBin * TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = DID10k)
DIDmodel10.1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = DID10k)


stargazer(DIDmodel1,DIDmodel3,DIDmodel5, DIDmodel10) #,type="text" )
stargazer(DIDmodel1.1,DIDmodel3.1,DIDmodel5.1, DIDmodel10.1) #,type="text" )





################## 2016-2023 Difference-in-Differences LnSalePrice and LnSalePriceper sqr foot ################## 



DID1k <- read.csv("data/1km_Boundary.csv")
DID1k <- DID1k[,1:25]
DID1k <- DID1k[DID1k$SalePrice < 2500000 & DID1k$SalePrice >= 1, ]
DID1k$FinishArea[DID1k$FinishArea == 0] <- 449
DID1k$LnSalePrice <- log(DID1k$SalePrice + 1)
DID1k$PricePerSqrft <- (DID1k$SalePrice/(DID1k$FinishArea))
DID1k$LnPricePerSqrft <- log((DID1k$SalePrice/(DID1k$FinishArea)))
DID1k <- DID1k[!is.na(DID1k$CoreBin) & !is.na(DID1k$Age) & !is.na(DID1k$FinishArea) & !is.na(DID1k$LnSalePrice) &  !is.na(DID1k$SalePrice),]
DID1k <- DID1k[!(DID1k$Year >= 2010 & DID1k$Year < 2015), ]



DIDmodel1 <- lm(LnSalePrice ~ CoreBin*TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = DID1k)
DIDmodel1.1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = DID1k)


#3k DID 
DID3k <- read.csv("data/3km_Boundary.csv")
DID3k <- DID3k[DID3k$SalePrice < 2500000 & DID3k$SalePrice >= 1, ]
DID3k$FinishArea[DID3k$FinishArea == 0] <- 449
DID3k$LnSalePrice <- log(DID3k$SalePrice + 1)
DID3k$PricePerSqrft <- (DID3k$SalePrice/(DID3k$FinishArea))
DID3k$LnPricePerSqrft <- log(DID3k$SalePrice/(DID3k$FinishArea))
DID3k <- DID3k[!is.na(DID3k$CoreBin) & !is.na(DID3k$Age) & !is.na(DID3k$FinishArea) & !is.na(DID3k$LnSalePrice) &  !is.na(DID3k$SalePrice),]
DID3k <- DID3k[!(DID3k$Year >= 2010 & DID3k$Year < 2015), ]

DIDmodel3 <- lm(LnSalePrice ~ CoreBin*TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = DID3k)
DIDmodel3.1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = DID3k)



#5k DID 
DID5k <- read.csv("data/5km_Boundary.csv")
DID5k <- DID5k[,1:25]
DID5k <- DID5k[DID5k$SalePrice < 2500000 & DID5k$SalePrice >= 1, ]
DID5k$FinishArea[DID5k$FinishArea == 0] <- 449
DID5k$LnSalePrice <- log(DID5k$SalePrice + 1)
DID5k$PricePerSqrft <- (DID5k$SalePrice/(DID5k$FinishArea))
DID5k$LnPricePerSqrft <- log(DID5k$SalePrice/(DID5k$FinishArea))
DID5k <- DID5k[!is.na(DID5k$CoreBin) & !is.na(DID5k$Age) & !is.na(DID5k$FinishArea) & !is.na(DID5k$LnSalePrice) &  !is.na(DID5k$SalePrice),]
DID5k <- DID5k[!(DID5k$Year >= 2010 & DID5k$Year < 2015), ]


DIDmodel5 <- lm(log(SalePrice) ~ CoreBin * TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = DID5k)
DIDmodel5.1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = DID5k)


#10k DID 
DID10k <- read.csv("data/10km_Boundary.csv")
DID10k <- DID10k[DID10k$SalePrice < 2500000 & DID10k$SalePrice >= 1, ]
DID10k$FinishArea[DID10k$FinishArea == 0] <- 449
DID10k$LnSalePrice <- log(DID10k$SalePrice + 1)
DID10k$PricePerSqrft <- (DID10k$SalePrice/(DID10k$FinishArea))
DID10k$LnPricePerSqrft <- log(DID10k$SalePrice/(DID10k$FinishArea))
DID10k <- DID10k[!is.na(DID10k$CoreBin) & !is.na(DID10k$Age) & !is.na(DID10k$FinishArea) & !is.na(DID10k$LnSalePrice) &  !is.na(DID10k$SalePrice),]
DID10k <- DID10k[!(DID10k$Year >= 2010 & DID10k$Year < 2015), ]


DIDmodel10 <- lm(log(SalePrice) ~ CoreBin * TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = DID10k)
DIDmodel10.1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = DID10k)


stargazer(DIDmodel1,DIDmodel3,DIDmodel5, DIDmodel10) #,type="text" )
stargazer(DIDmodel1.1,DIDmodel3.1,DIDmodel5.1, DIDmodel10.1) #,type="text" )


```

## Temporally Segmented DiD Regressions by Time Period (2010-2015, 2016-2023), with Matched Samples

```{r results = "asis"}
#Difference-in-Differences by time period (2010-2015, 2016-2023), with matched samples

################## 2010-2015 Difference-in-Differences LnSalePrice and LnSalePriceper sqr foot ################## 
#Propensity Score Matching

psvalue_top1 <- psvalue_top[!(psvalue_top$Year > 2016), ]

DIDpsvalue_top <- lm(LnSalePrice ~ CoreBin*TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = psvalue_top1)
DIDpsvalue_top1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = psvalue_top1)


#Generalized Boosted Matching 
gpsvalue_top1 <- gpsvalue_top[!(gpsvalue_top$Year > 2016), ]


DIDgpsvalue_top <- lm(LnSalePrice ~ CoreBin*TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = gpsvalue_top1)
DIDgpsvalue_top1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = gpsvalue_top1)



#Random Forest Matching
rf_psvalue_top1 <- rf_psvalue_top[!(rf_psvalue_top$Year > 2016), ]


DIDrf_psvalue_top <- lm(log(SalePrice) ~ CoreBin * TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = rf_psvalue_top1)
DIDrf_psvalue_top1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = rf_psvalue_top1)



stargazer(DIDpsvalue_top,DIDgpsvalue_top,DIDrf_psvalue_top) #,type="text" )
stargazer(DIDpsvalue_top1,DIDgpsvalue_top1,DIDrf_psvalue_top1) #,type="text" )


################## 2016-2023 Difference-in-Differences LnSalePrice and LnSalePriceper sqr foot ################## 


psvalue_top2 <- psvalue_top[!(psvalue_top$Year >= 2010 & psvalue_top$Year < 2015), ]

DIDpsvalue_top <- lm(LnSalePrice ~ CoreBin*TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = psvalue_top2)
DIDpsvalue_top1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = psvalue_top2)


#Generalized Boosted Matching 
gpsvalue_top2 <- gpsvalue_top[!(gpsvalue_top$Year >= 2010 & gpsvalue_top$Year < 2015), ]


DIDgpsvalue_top <- lm(LnSalePrice ~ CoreBin*TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = gpsvalue_top2)
DIDgpsvalue_top1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = gpsvalue_top2)



#Random Forest Matching
rf_psvalue_top2 <- rf_psvalue_top[!(rf_psvalue_top$Year >= 2010 & rf_psvalue_top$Year < 2015), ]


DIDrf_psvalue_top <- lm(log(SalePrice) ~ CoreBin * TimeBin + FinishArea + Age + factor(Tract) + factor(Year), data = rf_psvalue_top2)
DIDrf_psvalue_top1 <- lm(LnPricePerSqrft ~ CoreBin*TimeBin + Age + factor(Tract) + factor(Year), data = rf_psvalue_top2)



stargazer(DIDpsvalue_top,DIDgpsvalue_top,DIDrf_psvalue_top) #,type="text" )
stargazer(DIDpsvalue_top1,DIDgpsvalue_top1,DIDrf_psvalue_top1) #,type="text" )
```


# Estimating Quantile Treatment Effect (QTE) 

## Running Quantile Difference-in-Differences (Q-DiD) with Geographic Controls

The order of tables is: Yearly trends by 1 Kilometer Control, 3 Kilometer Control, 5 Kilometer Control, 10 Kilometer Control.

```{r}
#Quantile Difference-in-Differences, geographic controls

#Quantile DID 1 Km  
data1 <- read.csv("data/1km_Boundary.csv")
#data1 <- data1[data1$SalePrice < 2500000 & data1$SalePrice >= 1, ]
data1 <- data.frame(data1)
data1<- data1[, 1:23]
data1$FinishArea[data1$FinishArea == 0] <- 449
data1$LnSalePrice <- log(data1$SalePrice + 1)
data1$PricePerSqrft <- (data1$SalePrice+1)/(data1$FinishArea)
data1$LnPricePerSqrft <- log(((data1$SalePrice+1)/(data1$FinishArea))+1)
data1 <- data1[!is.na(data1$CoreBin) & !is.na(data1$Age) & !is.na(data1$FinishArea) & !is.na(data1$LnSalePrice) &  !is.na(data1$SalePrice),]

QDID1 <- rq(LnSalePrice ~ CoreBin*TimeBin + Age + FinishArea+ factor(QuarterByYear), data=data1, tau=c(.25,.50,.75))

summary(QDID1)
QDID1plot <- summary(QDID1)
#plot(QDID1plot)

QDID1.1 <- rq(LnPricePerSqrft ~ CoreBin*TimeBin + Age+ factor(QuarterByYear), data=data1, tau=c(.25,.50,.75))
summary(QDID1.1)
QDID1.1plot <- summary(QDID1.1)
#plot(QDID1.1plot)

#Quantile DID 3 Km  

data3 <- read.csv("data/3km_Boundary.csv")
#data3 <- data3[data3$SalePrice < 2500000 & data3$SalePrice >= 1, ]
data3 <- data.frame(data3)
data3<- data3[, 1:23]
data3$FinishArea[data3$FinishArea == 0] <- 449
data3$LnSalePrice <- log(data3$SalePrice + 1)
data3$PricePerSqrft <- (data3$SalePrice+1)/(data3$FinishArea)
data3$LnPricePerSqrft <- log(((data3$SalePrice+1)/(data3$FinishArea))+1)
data3 <- data3[!is.na(data3$CoreBin) & !is.na(data3$Age) & !is.na(data3$FinishArea) & !is.na(data3$LnSalePrice) &  !is.na(data3$SalePrice),]

QDID3 <- rq(LnSalePrice ~ CoreBin*TimeBin + Age + FinishArea+ factor(QuarterByYear), data=data3, tau=c(.25,.50,.75))
summary(QDID3)
QDID3plot <- summary(QDID3)
#plot(QDID3plot)

QDID3.1 <- rq(LnPricePerSqrft ~ CoreBin*TimeBin + Age+ factor(QuarterByYear), data=data3, tau=c(.25,.50,.75))
summary(QDID3.1)
QDID3.1plot <- summary(QDID3.1)
#plot(QDID3.1plot)


#Quantile DID 5 Km  
data5 <- read.csv("data/5km_Boundary.csv")
#data5 <- data5[data5$SalePrice < 2500000 & data5$SalePrice >= 1, ]

data5 <- data.frame(data5)
data5<- data5[, 1:23]
data5$FinishArea[data5$FinishArea == 0] <- 449
data5$LnSalePrice <- log(data5$SalePrice + 1)
data5$PricePerSqrft <- (data5$SalePrice+1)/(data5$FinishArea)
data5$LnPricePerSqrft <- log(((data5$SalePrice+1)/(data5$FinishArea))+1)
data5 <- data5[!is.na(data5$CoreBin) & !is.na(data5$Age) & !is.na(data5$FinishArea) & !is.na(data5$LnSalePrice) &  !is.na(data5$SalePrice),]


QDID5 <- rq(LnSalePrice ~ CoreBin*TimeBin + Age + FinishArea+ factor(QuarterByYear), data=data5, tau=c(.25,.50,.75))
summary(QDID5)
QDID5plot <- summary(QDID5)
#plot(QDID5plot)


QDID5.1 <- rq(LnPricePerSqrft ~ CoreBin*TimeBin + Age+ factor(QuarterByYear), data=data5, tau=c(.25,.50,.75))
summary(QDID5.1)
QDID5.1plot <- summary(QDID5.1)


#Quantile DID 10 Km  
data10 <- read.csv("data/10km_Boundary.csv")
#data10 <- data10[data10$SalePrice < 2500000 & data10$SalePrice >= 1, ]
data10 <- data.frame(data10)
data10<- data10[, 1:23]
data10$FinishArea[data10$FinishArea == 0] <- 449
data10$LnSalePrice <- log(data10$SalePrice + 1)
data10$PricePerSqrft <- (data10$SalePrice+1)/(data10$FinishArea)
data10$LnPricePerSqrft <- log(((data10$SalePrice+1)/(data10$FinishArea))+1)
data10 <- data10[!is.na(data10$CoreBin) & !is.na(data10$Age) & !is.na(data10$FinishArea) & !is.na(data10$LnSalePrice) &  !is.na(data10$SalePrice),]

QDID10 <- rq(LnSalePrice ~ CoreBin*TimeBin + Age + FinishArea+ factor(QuarterByYear), data=data10, tau=c(.25,.50,.75))
summary(QDID10)
QDID10plot <- summary(QDID10)
#plot(QDID10plot)


QDID10.1 <- rq(LnPricePerSqrft ~ CoreBin*TimeBin + Age+ factor(QuarterByYear), data=data10, tau=c(.25,.50,.75))
summary(QDID10.1)
QDID10.1plot <- summary(QDID10.1)
#plot(QDID10.1plot)


```

## Running Quantile Difference-in-Differences (Q-DiD) with Matched Controls 

The order of tables is: Propensity Score Matching (PSM) Control, Generalized Boosted Matching (GBM) Control, Random Forest Matching (RFM) Control.

```{r}

#################### Running the Q-DiD with Matched controls ###################

QDIDpsm <- rq(LnSalePrice ~ CoreBin*TimeBin + Age + FinishArea+ factor(QuarterByYear), data=psvalue_top, tau=c(.25,.50,.75))

summary(QDIDpsm)
QDIDpsmplot <- summary(QDIDpsm)
#plot(QDIDpsm)

QDIDpsm1 <- rq(LnPricePerSqrft ~ CoreBin*TimeBin + Age+ factor(QuarterByYear), data=psvalue_top, tau=c(.25,.50,.75))
summary(QDIDpsm1)
QDIDpsm1plot <- summary(QDIDpsm1)
#plot(QDIDpsm1)




QDIDgpsm <- rq(LnSalePrice ~ CoreBin*TimeBin + Age + FinishArea+ factor(QuarterByYear), data=gpsvalue_top, tau=c(.25,.50,.75))

summary(QDIDgpsm)
QDIDgpsmplot <- summary(QDIDgpsm)
#plot(QDIDgpsm)

QDIDgpsm1 <- rq(LnPricePerSqrft ~ CoreBin*TimeBin + Age+ factor(QuarterByYear), data=gpsvalue_top, tau=c(.25,.50,.75))
summary(QDIDgpsm1)
QDIDgpsm1plot <- summary(QDIDgpsm1)
#plot(QDIDgpsm1)




QDIDrfm <- rq(LnSalePrice ~ CoreBin*TimeBin + Age + FinishArea+ factor(QuarterByYear), data=rf_psvalue_top, tau=c(.25,.50,.75))

summary(QDIDrfm)
QDIDrfmplot <- summary(QDIDrfm)
#plot(QDIDrfm)

QDIDrfm1 <- rq(LnPricePerSqrft ~ CoreBin*TimeBin + Age+ factor(QuarterByYear), data=rf_psvalue_top, tau=c(.25,.50,.75))
summary(QDIDrfm1)
QDIDrfm1plot <- summary(QDIDrfm1)
#plot(QDIDrfm1)

```
